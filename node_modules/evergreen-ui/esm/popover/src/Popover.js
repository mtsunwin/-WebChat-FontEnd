var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

import React, { Component } from 'react';
import PropTypes from 'prop-types';
import { Position, Positioner } from '../../positioner';
import PopoverStateless from './PopoverStateless';

var Popover = function (_Component) {
  _inherits(Popover, _Component);

  function Popover(props) {
    _classCallCheck(this, Popover);

    var _this = _possibleConstructorReturn(this, (Popover.__proto__ || Object.getPrototypeOf(Popover)).call(this, props));

    _this.bringFocusInside = function () {
      if (!_this.props.bringFocusInside) return;

      // Always delay focus manipulation to just before repaint to prevent scroll jumping
      return requestAnimationFrame(function () {
        // Container ref may be undefined between component mounting and Portal rendering
        // activeElement may be undefined in some rare cases in IE

        if (_this.popoverNode == null || // eslint-disable-line eqeqeq, no-eq-null
        document.activeElement == null || // eslint-disable-line eqeqeq, no-eq-null
        !_this.props.isShown) {
          return;
        }

        var isFocusOutsideModal = !_this.popoverNode.contains(document.activeElement);
        if (isFocusOutsideModal) {
          // Element marked autofocus has higher priority than the other clowns
          var autofocusElement = _this.popoverNode.querySelector('[autofocus]');
          var wrapperElement = _this.popoverNode.querySelector('[tabindex]');
          var buttonElement = _this.popoverNode.querySelector('button');

          if (autofocusElement) {
            autofocusElement.focus();
          } else if (wrapperElement) {
            wrapperElement.focus();
          } else if (buttonElement) {
            buttonElement.focus();
          }
        }
      });
    };

    _this.bringFocusBackToTarget = function () {
      return requestAnimationFrame(function () {
        if (_this.popoverNode == null || // eslint-disable-line eqeqeq, no-eq-null
        document.activeElement == null // eslint-disable-line eqeqeq, no-eq-null
        ) {
            return;
          }

        var isFocusInsideModal = _this.popoverNode.contains(document.activeElement);

        // Bring back focus on the target.
        if (_this.targetRef && (document.activeElement === document.body || isFocusInsideModal)) {
          _this.targetRef.focus();
        }
      });
    };

    _this.onBodyClick = function (e) {
      // Ignore clicks on the popover or button
      if (_this.targetRef === e.target) {
        return;
      }

      if (_this.popoverNode && (_this.popoverNode === e.target || _this.popoverNode.contains(e.target))) {
        return;
      }

      _this.close();
    };

    _this.onEsc = function (e) {
      // Esc key
      if (e.keyCode === 27) {
        _this.close();
      }
    };

    _this.toggle = function () {
      if (_this.state.isShown) {
        _this.close();
      } else {
        _this.open();
      }
    };

    _this.open = function () {
      if (_this.state.isShown) {
        return;
      }

      _this.setState({ isShown: true });
      document.body.addEventListener('click', _this.onBodyClick, false);
      document.body.addEventListener('keydown', _this.onEsc, false);

      _this.props.onOpen();
    };

    _this.close = function () {
      if (!_this.state.isShown) {
        return;
      }

      _this.setState({ isShown: false });
      document.body.removeEventListener('click', _this.onBodyClick, false);
      document.body.removeEventListener('keydown', _this.onEsc, false);

      _this.bringFocusBackToTarget();

      _this.props.onClose();
    };

    _this.handleOpenComplete = function () {
      _this.bringFocusInside();
      _this.props.onOpenComplete();
    };

    _this.handleCloseComplete = function () {
      _this.props.onCloseComplete();
    };

    _this.renderTarget = function (_ref) {
      var getRef = _ref.getRef,
          isShown = _ref.isShown;
      var children = _this.props.children;


      var getTargetRef = function getTargetRef(ref) {
        _this.targetRef = ref;
        getRef(ref);
      };

      if (typeof children === 'function') {
        return children({
          toggle: _this.toggle,
          getRef: getTargetRef,
          isShown: isShown
        });
      }

      return React.cloneElement(children, {
        onClick: _this.toggle,
        innerRef: getTargetRef,
        role: 'button',
        'aria-expanded': isShown,
        'aria-haspopup': true
      });
    };

    _this.state = {
      isShown: props.isShown
    };
    return _this;
  }

  _createClass(Popover, [{
    key: 'componentWillUnmount',
    value: function componentWillUnmount() {
      document.body.removeEventListener('click', this.onBodyClick, false);
      document.body.removeEventListener('keydown', this.onEsc, false);
    }

    /**
     * Methods borrowed from BlueprintJS
     * https://github.com/palantir/blueprint/blob/release/2.0.0/packages/core/src/components/overlay/overlay.tsx
     */

  }, {
    key: 'render',
    value: function render() {
      var _this2 = this;

      var _props = this.props,
          zIndex = _props.zIndex,
          isShown = _props.isShown,
          content = _props.content,
          display = _props.display,
          minWidth = _props.minWidth,
          position = _props.position,
          minHeight = _props.minHeight,
          statelessProps = _props.statelessProps,
          animationDuration = _props.animationDuration,
          onCloseComplete = _props.onCloseComplete;
      var stateIsShown = this.state.isShown;


      var shown = isShown || stateIsShown;

      return React.createElement(
        Positioner,
        {
          target: function target(_ref2) {
            var getRef = _ref2.getRef,
                isShown = _ref2.isShown,
                targetWidth = _ref2.targetWidth;

            return _this2.renderTarget({ getRef: getRef, isShown: isShown, targetWidth: targetWidth });
          },
          zIndex: zIndex,
          isShown: shown,
          position: position,
          animationDuration: animationDuration,
          onOpenComplete: this.handleOpenComplete,
          onCloseComplete: onCloseComplete
        },
        function (_ref3) {
          var css = _ref3.css,
              style = _ref3.style,
              state = _ref3.state,
              getRef = _ref3.getRef;
          return React.createElement(
            PopoverStateless,
            _extends({
              innerRef: function innerRef(ref) {
                _this2.popoverNode = ref;
                getRef(ref);
              },
              'data-state': state,
              css: css,
              style: style,
              display: display,
              minWidth: minWidth,
              minHeight: minHeight
            }, statelessProps),
            typeof content === 'function' ? content({ close: _this2.close }) : content
          );
        }
      );
    }
  }]);

  return Popover;
}(Component);

Popover.propTypes = {
  /**
   * The position the Popover is on. Smart positioning might override this.
   */
  position: PropTypes.oneOf(Object.keys(Position)),

  /**
   * When true, the Popover is manually shown.
   */
  isShown: PropTypes.bool,

  /**
   * The content of the Popover.
   */
  content: PropTypes.oneOfType([PropTypes.node, PropTypes.func]).isRequired,

  /**
   * The target button of the Popover.
   * When a function the following arguments are passed:
   * ({ toggle: Function -> Void, getRef: Function -> Ref, isShown: Bool })
   */
  children: PropTypes.oneOfType([PropTypes.element, PropTypes.func]).isRequired,

  /**
   * The display property passed to the Popover card.
   */
  display: PropTypes.string,

  /**
   * The min width of the Popover card.
   */
  minWidth: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),

  /**
   * The min height of the Popover card.
   */
  minHeight: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),

  /**
   * Properties passed through to the Popover card.
   */
  statelessProps: PropTypes.objectOf(PopoverStateless.propTypes),

  /**
   * Duration of the animation.
   */
  animationDuration: PropTypes.number,

  /**
   * The z-index of the Popover card.
   */
  zIndex: PropTypes.number,

  /**
   * Function called when the Popover opens.
   */
  onOpen: PropTypes.func.isRequired,

  /**
   * Function fired when Popover closes.
   */
  onClose: PropTypes.func.isRequired,

  /**
   * Function that will be called when the enter transition is complete.
   */
  onOpenComplete: PropTypes.func.isRequired,

  /**
   * Function that will be called when the exit transition is complete.
   */
  onCloseComplete: PropTypes.func.isRequired,

  /**
   * When true, bring focus inside of the Popover on open.
   */
  bringFocusInside: PropTypes.bool
};
Popover.defaultProps = {
  position: Position.BOTTOM,
  isShown: false,
  minWidth: 200,
  minHeight: 40,
  animationDuration: 300,
  zIndex: 40,
  onOpen: function onOpen() {},
  onClose: function onClose() {},
  onOpenComplete: function onOpenComplete() {},
  onCloseComplete: function onCloseComplete() {},
  bringFocusInside: true
};
export default Popover;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wb3BvdmVyL3NyYy9Qb3BvdmVyLmpzIl0sIm5hbWVzIjpbIlJlYWN0IiwiQ29tcG9uZW50IiwiUHJvcFR5cGVzIiwiUG9zaXRpb24iLCJQb3NpdGlvbmVyIiwiUG9wb3ZlclN0YXRlbGVzcyIsIlBvcG92ZXIiLCJwcm9wcyIsImJyaW5nRm9jdXNJbnNpZGUiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJwb3BvdmVyTm9kZSIsImRvY3VtZW50IiwiYWN0aXZlRWxlbWVudCIsImlzU2hvd24iLCJpc0ZvY3VzT3V0c2lkZU1vZGFsIiwiY29udGFpbnMiLCJhdXRvZm9jdXNFbGVtZW50IiwicXVlcnlTZWxlY3RvciIsIndyYXBwZXJFbGVtZW50IiwiYnV0dG9uRWxlbWVudCIsImZvY3VzIiwiYnJpbmdGb2N1c0JhY2tUb1RhcmdldCIsImlzRm9jdXNJbnNpZGVNb2RhbCIsInRhcmdldFJlZiIsImJvZHkiLCJvbkJvZHlDbGljayIsImUiLCJ0YXJnZXQiLCJjbG9zZSIsIm9uRXNjIiwia2V5Q29kZSIsInRvZ2dsZSIsInN0YXRlIiwib3BlbiIsInNldFN0YXRlIiwiYWRkRXZlbnRMaXN0ZW5lciIsIm9uT3BlbiIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJvbkNsb3NlIiwiaGFuZGxlT3BlbkNvbXBsZXRlIiwib25PcGVuQ29tcGxldGUiLCJoYW5kbGVDbG9zZUNvbXBsZXRlIiwib25DbG9zZUNvbXBsZXRlIiwicmVuZGVyVGFyZ2V0IiwiZ2V0UmVmIiwiY2hpbGRyZW4iLCJnZXRUYXJnZXRSZWYiLCJyZWYiLCJjbG9uZUVsZW1lbnQiLCJvbkNsaWNrIiwiaW5uZXJSZWYiLCJyb2xlIiwiekluZGV4IiwiY29udGVudCIsImRpc3BsYXkiLCJtaW5XaWR0aCIsInBvc2l0aW9uIiwibWluSGVpZ2h0Iiwic3RhdGVsZXNzUHJvcHMiLCJhbmltYXRpb25EdXJhdGlvbiIsInN0YXRlSXNTaG93biIsInNob3duIiwidGFyZ2V0V2lkdGgiLCJjc3MiLCJzdHlsZSIsInByb3BUeXBlcyIsIm9uZU9mIiwiT2JqZWN0Iiwia2V5cyIsImJvb2wiLCJvbmVPZlR5cGUiLCJub2RlIiwiZnVuYyIsImlzUmVxdWlyZWQiLCJlbGVtZW50Iiwic3RyaW5nIiwibnVtYmVyIiwib2JqZWN0T2YiLCJkZWZhdWx0UHJvcHMiLCJCT1RUT00iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSxPQUFPQSxLQUFQLElBQWdCQyxTQUFoQixRQUFpQyxPQUFqQztBQUNBLE9BQU9DLFNBQVAsTUFBc0IsWUFBdEI7QUFDQSxTQUFTQyxRQUFULEVBQW1CQyxVQUFuQixRQUFxQyxrQkFBckM7QUFDQSxPQUFPQyxnQkFBUCxNQUE2QixvQkFBN0I7O0lBRXFCQyxPOzs7QUErRm5CLG1CQUFZQyxLQUFaLEVBQW1CO0FBQUE7O0FBQUEsa0hBQ1hBLEtBRFc7O0FBQUEsVUFnQm5CQyxnQkFoQm1CLEdBZ0JBLFlBQU07QUFDdkIsVUFBSSxDQUFDLE1BQUtELEtBQUwsQ0FBV0MsZ0JBQWhCLEVBQWtDOztBQUVsQztBQUNBLGFBQU9DLHNCQUFzQixZQUFNO0FBQ2pDO0FBQ0E7O0FBRUEsWUFDRSxNQUFLQyxXQUFMLElBQW9CLElBQXBCLElBQTRCO0FBQzVCQyxpQkFBU0MsYUFBVCxJQUEwQixJQUQxQixJQUNrQztBQUNsQyxTQUFDLE1BQUtMLEtBQUwsQ0FBV00sT0FIZCxFQUlFO0FBQ0E7QUFDRDs7QUFFRCxZQUFNQyxzQkFBc0IsQ0FBQyxNQUFLSixXQUFMLENBQWlCSyxRQUFqQixDQUMzQkosU0FBU0MsYUFEa0IsQ0FBN0I7QUFHQSxZQUFJRSxtQkFBSixFQUF5QjtBQUN2QjtBQUNBLGNBQU1FLG1CQUFtQixNQUFLTixXQUFMLENBQWlCTyxhQUFqQixDQUErQixhQUEvQixDQUF6QjtBQUNBLGNBQU1DLGlCQUFpQixNQUFLUixXQUFMLENBQWlCTyxhQUFqQixDQUErQixZQUEvQixDQUF2QjtBQUNBLGNBQU1FLGdCQUFnQixNQUFLVCxXQUFMLENBQWlCTyxhQUFqQixDQUErQixRQUEvQixD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QW1CekQsVUFBVTBFLE1BL0NaOztBQWlEakI7OztBQUdBeEIsVUFBUWxELFVBQVUwRSxNQXBERDs7QUFzRGpCOzs7QUFHQXhDLFVBQVFsQyxVQUFVc0UsSUFBVixDQUFlQyxVQXpETjs7QUEyRGpCOzs7QUFHQW5DLFdBQVNwQyxVQUFVc0UsSUFBVixDQUFlQyxVQTlEUDs7QUFnRWpCOzs7QUFHQWpDLGtCQUFnQnRDLFVBQVVzRSxJQUFWLENBQWVDLFVBbkVkOztBQXFFakI7OztBQUdBL0IsbUJBQWlCeEMsVUFBVXNFLElBQVYsQ0FBZUMsVUF4RWY7O0FBMEVqQjs7O0FBR0FqRSxvQkFBa0JOLFVBQVVtRTtBQTdFWCxDO0FBREEvRCxPLENBaUZad0UsWSxHQUFlO0FBQ3BCdEIsWUFBVXJELFNBQVM0RSxNQURDO0FBRXBCbEUsV0FBUyxLQUZXO0FBR3BCMEMsWUFBVSxHQUhVO0FBSXBCRSxhQUFXLEVBSlM7QUFLcEJFLHFCQUFtQixHQUxDO0FBTXBCUCxVQUFRLEVBTlk7QUFPcEJoQixVQUFRLGtCQUFNLENBQUUsQ0FQSTtBQVFwQkUsV0FBUyxtQkFBTSxDQUFFLENBUkc7QUFTcEJFLGtCQUFnQiwwQkFBTSxDQUFFLENBVEo7QUFVcEJFLG1CQUFpQiwyQkFBTSxDQUFFLENBVkw7QUFXcEJsQyxvQkFBa0I7QUFYRSxDO2VBakZIRixPIiwiZmlsZSI6IlBvcG92ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50IH0gZnJvbSAncmVhY3QnXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnXG5pbXBvcnQgeyBQb3NpdGlvbiwgUG9zaXRpb25lciB9IGZyb20gJy4uLy4uL3Bvc2l0aW9uZXInXG5pbXBvcnQgUG9wb3ZlclN0YXRlbGVzcyBmcm9tICcuL1BvcG92ZXJTdGF0ZWxlc3MnXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBvcG92ZXIgZXh0ZW5kcyBDb21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIC8qKlxuICAgICAqIFRoZSBwb3NpdGlvbiB0aGUgUG9wb3ZlciBpcyBvbi4gU21hcnQgcG9zaXRpb25pbmcgbWlnaHQgb3ZlcnJpZGUgdGhpcy5cbiAgICAgKi9cbiAgICBwb3NpdGlvbjogUHJvcFR5cGVzLm9uZU9mKE9iamVjdC5rZXlzKFBvc2l0aW9uKSksXG5cbiAgICAvKipcbiAgICAgKiBXaGVuIHRydWUsIHRoZSBQb3BvdmVyIGlzIG1hbnVhbGx5IHNob3duLlxuICAgICAqL1xuICAgIGlzU2hvd246IFByb3BUeXBlcy5ib29sLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGNvbnRlbnQgb2YgdGhlIFBvcG92ZXIuXG4gICAgICovXG4gICAgY29udGVudDogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLm5vZGUsIFByb3BUeXBlcy5mdW5jXSkuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIFRoZSB0YXJnZXQgYnV0dG9uIG9mIHRoZSBQb3BvdmVyLlxuICAgICAqIFdoZW4gYSBmdW5jdGlvbiB0aGUgZm9sbG93aW5nIGFyZ3VtZW50cyBhcmUgcGFzc2VkOlxuICAgICAqICh7IHRvZ2dsZTogRnVuY3Rpb24gLT4gVm9pZCwgZ2V0UmVmOiBGdW5jdGlvbiAtPiBSZWYsIGlzU2hvd246IEJvb2wgfSlcbiAgICAgKi9cbiAgICBjaGlsZHJlbjogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLmVsZW1lbnQsIFByb3BUeXBlcy5mdW5jXSlcbiAgICAgIC5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGRpc3BsYXkgcHJvcGVydHkgcGFzc2VkIHRvIHRoZSBQb3BvdmVyIGNhcmQuXG4gICAgICovXG4gICAgZGlzcGxheTogUHJvcFR5cGVzLnN0cmluZyxcblxuICAgIC8qKlxuICAgICAqIFRoZSBtaW4gd2lkdGggb2YgdGhlIFBvcG92ZXIgY2FyZC5cbiAgICAgKi9cbiAgICBtaW5XaWR0aDogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLm51bWJlciwgUHJvcFR5cGVzLnN0cmluZ10pLFxuXG4gICAgLyoqXG4gICAgICogVGhlIG1pbiBoZWlnaHQgb2YgdGhlIFBvcG92ZXIgY2FyZC5cbiAgICAgKi9cbiAgICBtaW5IZWlnaHQ6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5udW1iZXIsIFByb3BUeXBlcy5zdHJpbmddKSxcblxuICAgIC8qKlxuICAgICAqIFByb3BlcnRpZXMgcGFzc2VkIHRocm91Z2ggdG8gdGhlIFBvcG92ZXIgY2FyZC5cbiAgICAgKi9cbiAgICBzdGF0ZWxlc3NQcm9wczogUHJvcFR5cGVzLm9iamVjdE9mKFBvcG92ZXJTdGF0ZWxlc3MucHJvcFR5cGVzKSxcblxuICAgIC8qKlxuICAgICAqIER1cmF0aW9uIG9mIHRoZSBhbmltYXRpb24uXG4gICAgICovXG4gICAgYW5pbWF0aW9uRHVyYXRpb246IFByb3BUeXBlcy5udW1iZXIsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgei1pbmRleCBvZiB0aGUgUG9wb3ZlciBjYXJkLlxuICAgICAqL1xuICAgIHpJbmRleDogUHJvcFR5cGVzLm51bWJlcixcblxuICAgIC8qKlxuICAgICAqIEZ1bmN0aW9uIGNhbGxlZCB3aGVuIHRoZSBQb3BvdmVyIG9wZW5zLlxuICAgICAqL1xuICAgIG9uT3BlbjogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIEZ1bmN0aW9uIGZpcmVkIHdoZW4gUG9wb3ZlciBjbG9zZXMuXG4gICAgICovXG4gICAgb25DbG9zZTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgZW50ZXIgdHJhbnNpdGlvbiBpcyBjb21wbGV0ZS5cbiAgICAgKi9cbiAgICBvbk9wZW5Db21wbGV0ZTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgZXhpdCB0cmFuc2l0aW9uIGlzIGNvbXBsZXRlLlxuICAgICAqL1xuICAgIG9uQ2xvc2VDb21wbGV0ZTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIFdoZW4gdHJ1ZSwgYnJpbmcgZm9jdXMgaW5zaWRlIG9mIHRoZSBQb3BvdmVyIG9uIG9wZW4uXG4gICAgICovXG4gICAgYnJpbmdGb2N1c0luc2lkZTogUHJvcFR5cGVzLmJvb2xcbiAgfVxuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgcG9zaXRpb246IFBvc2l0aW9uLkJPVFRPTSxcbiAgICBpc1Nob3duOiBmYWxzZSxcbiAgICBtaW5XaWR0aDogMjAwLFxuICAgIG1pbkhlaWdodDogNDAsXG4gICAgYW5pbWF0aW9uRHVyYXRpb246IDMwMCxcbiAgICB6SW5kZXg6IDQwLFxuICAgIG9uT3BlbjogKCkgPT4ge30sXG4gICAgb25DbG9zZTogKCkgPT4ge30sXG4gICAgb25PcGVuQ29tcGxldGU6ICgpID0+IHt9LFxuICAgIG9uQ2xvc2VDb21wbGV0ZTogKCkgPT4ge30sXG4gICAgYnJpbmdGb2N1c0luc2lkZTogdHJ1ZVxuICB9XG5cbiAgY29uc3RydWN0b3IocHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcylcbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgaXNTaG93bjogcHJvcHMuaXNTaG93blxuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLm9uQm9keUNsaWNrLCBmYWxzZSlcbiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLm9uRXNjLCBmYWxzZSlcbiAgfVxuXG4gIC8qKlxuICAgKiBNZXRob2RzIGJvcnJvd2VkIGZyb20gQmx1ZXByaW50SlNcbiAgICogaHR0cHM6Ly9naXRodWIuY29tL3BhbGFudGlyL2JsdWVwcmludC9ibG9iL3JlbGVhc2UvMi4wLjAvcGFja2FnZXMvY29yZS9zcmMvY29tcG9uZW50cy9vdmVybGF5L292ZXJsYXkudHN4XG4gICAqL1xuICBicmluZ0ZvY3VzSW5zaWRlID0gKCkgPT4ge1xuICAgIGlmICghdGhpcy5wcm9wcy5icmluZ0ZvY3VzSW5zaWRlKSByZXR1cm5cblxuICAgIC8vIEFsd2F5cyBkZWxheSBmb2N1cyBtYW5pcHVsYXRpb24gdG8ganVzdCBiZWZvcmUgcmVwYWludCB0byBwcmV2ZW50IHNjcm9sbCBqdW1waW5nXG4gICAgcmV0dXJuIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAvLyBDb250YWluZXIgcmVmIG1heSBiZSB1bmRlZmluZWQgYmV0d2VlbiBjb21wb25lbnQgbW91bnRpbmcgYW5kIFBvcnRhbCByZW5kZXJpbmdcbiAgICAgIC8vIGFjdGl2ZUVsZW1lbnQgbWF5IGJlIHVuZGVmaW5lZCBpbiBzb21lIHJhcmUgY2FzZXMgaW4gSUVcblxuICAgICAgaWYgKFxuICAgICAgICB0aGlzLnBvcG92ZXJOb2RlID09IG51bGwgfHwgLy8gZXNsaW50LWRpc2FibGUtbGluZSBlcWVxZXEsIG5vLWVxLW51bGxcbiAgICAgICAgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PSBudWxsIHx8IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgZXFlcWVxLCBuby1lcS1udWxsXG4gICAgICAgICF0aGlzLnByb3BzLmlzU2hvd25cbiAgICAgICkge1xuICAgICAgICByZXR1cm5cbiAgICAgIH1cblxuICAgICAgY29uc3QgaXNGb2N1c091dHNpZGVNb2RhbCA9ICF0aGlzLnBvcG92ZXJOb2RlLmNvbnRhaW5zKFxuICAgICAgICBkb2N1bWVudC5hY3RpdmVFbGVtZW50XG4gICAgICApXG4gICAgICBpZiAoaXNGb2N1c091dHNpZGVNb2RhbCkge1xuICAgICAgICAvLyBFbGVtZW50IG1hcmtlZCBhdXRvZm9jdXMgaGFzIGhpZ2hlciBwcmlvcml0eSB0aGFuIHRoZSBvdGhlciBjbG93bnNcbiAgICAgICAgY29uc3QgYXV0b2ZvY3VzRWxlbWVudCA9IHRoaXMucG9wb3Zlck5vZGUucXVlcnlTZWxlY3RvcignW2F1dG9mb2N1c10nKVxuICAgICAgICBjb25zdCB3cmFwcGVyRWxlbWVudCA9IHRoaXMucG9wb3Zlck5vZGUucXVlcnlTZWxlY3RvcignW3RhYmluZGV4XScpXG4gICAgICAgIGNvbnN0IGJ1dHRvbkVsZW1lbnQgPSB0aGlzLnBvcG92ZXJOb2RlLnF1ZXJ5U2VsZWN0b3IoJ2J1dHRvbicpXG5cbiAgICAgICAgaWYgKGF1dG9mb2N1c0VsZW1lbnQpIHtcbiAgICAgICAgICBhdXRvZm9jdXNFbGVtZW50LmZvY3VzKClcbiAgICAgICAgfSBlbHNlIGlmICh3cmFwcGVyRWxlbWVudCkge1xuICAgICAgICAgIHdyYXBwZXJFbGVtZW50LmZvY3VzKClcbiAgICAgICAgfSBlbHNlIGlmIChidXR0b25FbGVtZW50KSB7XG4gICAgICAgICAgYnV0dG9uRWxlbWVudC5mb2N1cygpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgYnJpbmdGb2N1c0JhY2tUb1RhcmdldCA9ICgpID0+IHtcbiAgICByZXR1cm4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIGlmIChcbiAgICAgICAgdGhpcy5wb3BvdmVyTm9kZSA9PSBudWxsIHx8IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgZXFlcWVxLCBuby1lcS1udWxsXG4gICAgICAgIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT0gbnVsbCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGVxZXFlcSwgbm8tZXEtbnVsbFxuICAgICAgKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBjb25zdCBpc0ZvY3VzSW5zaWRlTW9kYWwgPSB0aGlzLnBvcG92ZXJOb2RlLmNvbnRhaW5zKFxuICAgICAgICBkb2N1bWVudC5hY3RpdmVFbGVtZW50XG4gICAgICApXG5cbiAgICAgIC8vIEJyaW5nIGJhY2sgZm9jdXMgb24gdGhlIHRhcmdldC5cbiAgICAgIGlmIChcbiAgICAgICAgdGhpcy50YXJnZXRSZWYgJiZcbiAgICAgICAgKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IGRvY3VtZW50LmJvZHkgfHwgaXNGb2N1c0luc2lkZU1vZGFsKVxuICAgICAgKSB7XG4gICAgICAgIHRoaXMudGFyZ2V0UmVmLmZvY3VzKClcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgb25Cb2R5Q2xpY2sgPSBlID0+IHtcbiAgICAvLyBJZ25vcmUgY2xpY2tzIG9uIHRoZSBwb3BvdmVyIG9yIGJ1dHRvblxuICAgIGlmICh0aGlzLnRhcmdldFJlZiA9PT0gZS50YXJnZXQpIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGlmIChcbiAgICAgIHRoaXMucG9wb3Zlck5vZGUgJiZcbiAgICAgICh0aGlzLnBvcG92ZXJOb2RlID09PSBlLnRhcmdldCB8fCB0aGlzLnBvcG92ZXJOb2RlLmNvbnRhaW5zKGUudGFyZ2V0KSlcbiAgICApIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIHRoaXMuY2xvc2UoKVxuICB9XG5cbiAgb25Fc2MgPSBlID0+IHtcbiAgICAvLyBFc2Mga2V5XG4gICAgaWYgKGUua2V5Q29kZSA9PT0gMjcpIHtcbiAgICAgIHRoaXMuY2xvc2UoKVxuICAgIH1cbiAgfVxuXG4gIHRvZ2dsZSA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5zdGF0ZS5pc1Nob3duKSB7XG4gICAgICB0aGlzLmNsb3NlKClcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5vcGVuKClcbiAgICB9XG4gIH1cblxuICBvcGVuID0gKCkgPT4ge1xuICAgIGlmICh0aGlzLnN0YXRlLmlzU2hvd24pIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIHRoaXMuc2V0U3RhdGUoeyBpc1Nob3duOiB0cnVlIH0pXG4gICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25Cb2R5Q2xpY2ssIGZhbHNlKVxuICAgIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMub25Fc2MsIGZhbHNlKVxuXG4gICAgdGhpcy5wcm9wcy5vbk9wZW4oKVxuICB9XG5cbiAgY2xvc2UgPSAoKSA9PiB7XG4gICAgaWYgKCF0aGlzLnN0YXRlLmlzU2hvd24pIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIHRoaXMuc2V0U3RhdGUoeyBpc1Nob3duOiBmYWxzZSB9KVxuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLm9uQm9keUNsaWNrLCBmYWxzZSlcbiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLm9uRXNjLCBmYWxzZSlcblxuICAgIHRoaXMuYnJpbmdGb2N1c0JhY2tUb1RhcmdldCgpXG5cbiAgICB0aGlzLnByb3BzLm9uQ2xvc2UoKVxuICB9XG5cbiAgaGFuZGxlT3BlbkNvbXBsZXRlID0gKCkgPT4ge1xuICAgIHRoaXMuYnJpbmdGb2N1c0luc2lkZSgpXG4gICAgdGhpcy5wcm9wcy5vbk9wZW5Db21wbGV0ZSgpXG4gIH1cblxuICBoYW5kbGVDbG9zZUNvbXBsZXRlID0gKCkgPT4ge1xuICAgIHRoaXMucHJvcHMub25DbG9zZUNvbXBsZXRlKClcbiAgfVxuXG4gIHJlbmRlclRhcmdldCA9ICh7IGdldFJlZiwgaXNTaG93biB9KSA9PiB7XG4gICAgY29uc3QgeyBjaGlsZHJlbiB9ID0gdGhpcy5wcm9wc1xuXG4gICAgY29uc3QgZ2V0VGFyZ2V0UmVmID0gcmVmID0+IHtcbiAgICAgIHRoaXMudGFyZ2V0UmVmID0gcmVmXG4gICAgICBnZXRSZWYocmVmKVxuICAgIH1cblxuICAgIGlmICh0eXBlb2YgY2hpbGRyZW4gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHJldHVybiBjaGlsZHJlbih7XG4gICAgICAgIHRvZ2dsZTogdGhpcy50b2dnbGUsXG4gICAgICAgIGdldFJlZjogZ2V0VGFyZ2V0UmVmLFxuICAgICAgICBpc1Nob3duXG4gICAgICB9KVxuICAgIH1cblxuICAgIHJldHVybiBSZWFjdC5jbG9uZUVsZW1lbnQoY2hpbGRyZW4sIHtcbiAgICAgIG9uQ2xpY2s6IHRoaXMudG9nZ2xlLFxuICAgICAgaW5uZXJSZWY6IGdldFRhcmdldFJlZixcbiAgICAgIHJvbGU6ICdidXR0b24nLFxuICAgICAgJ2FyaWEtZXhwYW5kZWQnOiBpc1Nob3duLFxuICAgICAgJ2FyaWEtaGFzcG9wdXAnOiB0cnVlXG4gICAgfSlcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7XG4gICAgICB6SW5kZXgsXG4gICAgICBpc1Nob3duLFxuICAgICAgY29udGVudCxcbiAgICAgIGRpc3BsYXksXG4gICAgICBtaW5XaWR0aCxcbiAgICAgIHBvc2l0aW9uLFxuICAgICAgbWluSGVpZ2h0LFxuICAgICAgc3RhdGVsZXNzUHJvcHMsXG4gICAgICBhbmltYXRpb25EdXJhdGlvbixcbiAgICAgIG9uQ2xvc2VDb21wbGV0ZVxuICAgIH0gPSB0aGlzLnByb3BzXG4gICAgY29uc3QgeyBpc1Nob3duOiBzdGF0ZUlzU2hvd24gfSA9IHRoaXMuc3RhdGVcblxuICAgIGNvbnN0IHNob3duID0gaXNTaG93biB8fCBzdGF0ZUlzU2hvd25cblxuICAgIHJldHVybiAoXG4gICAgICA8UG9zaXRpb25lclxuICAgICAgICB0YXJnZXQ9eyh7IGdldFJlZiwgaXNTaG93biwgdGFyZ2V0V2lkdGggfSkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGlzLnJlbmRlclRhcmdldCh7IGdldFJlZiwgaXNTaG93biwgdGFyZ2V0V2lkdGggfSlcbiAgICAgICAgfX1cbiAgICAgICAgekluZGV4PXt6SW5kZXh9XG4gICAgICAgIGlzU2hvd249e3Nob3dufVxuICAgICAgICBwb3NpdGlvbj17cG9zaXRpb259XG4gICAgICAgIGFuaW1hdGlvbkR1cmF0aW9uPXthbmltYXRpb25EdXJhdGlvbn1cbiAgICAgICAgb25PcGVuQ29tcGxldGU9e3RoaXMuaGFuZGxlT3BlbkNvbXBsZXRlfVxuICAgICAgICBvbkNsb3NlQ29tcGxldGU9e29uQ2xvc2VDb21wbGV0ZX1cbiAgICAgID5cbiAgICAgICAgeyh7IGNzcywgc3R5bGUsIHN0YXRlLCBnZXRSZWYgfSkgPT4gKFxuICAgICAgICAgIDxQb3BvdmVyU3RhdGVsZXNzXG4gICAgICAgICAgICBpbm5lclJlZj17cmVmID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5wb3BvdmVyTm9kZSA9IHJlZlxuICAgICAgICAgICAgICBnZXRSZWYocmVmKVxuICAgICAgICAgICAgfX1cbiAgICAgICAgICAgIGRhdGEtc3RhdGU9e3N0YXRlfVxuICAgICAgICAgICAgY3NzPXtjc3N9XG4gICAgICAgICAgICBzdHlsZT17c3R5bGV9XG4gICAgICAgICAgICBkaXNwbGF5PXtkaXNwbGF5fVxuICAgICAgICAgICAgbWluV2lkdGg9e21pbldpZHRofVxuICAgICAgICAgICAgbWluSGVpZ2h0PXttaW5IZWlnaHR9XG4gICAgICAgICAgICB7Li4uc3RhdGVsZXNzUHJvcHN9XG4gICAgICAgICAgPlxuICAgICAgICAgICAge3R5cGVvZiBjb250ZW50ID09PSAnZnVuY3Rpb24nXG4gICAgICAgICAgICAgID8gY29udGVudCh7IGNsb3NlOiB0aGlzLmNsb3NlIH0pXG4gICAgICAgICAgICAgIDogY29udGVudH1cbiAgICAgICAgICA8L1BvcG92ZXJTdGF0ZWxlc3M+XG4gICAgICAgICl9XG4gICAgICA8L1Bvc2l0aW9uZXI+XG4gICAgKVxuICB9XG59XG4iXX0=