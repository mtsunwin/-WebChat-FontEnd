'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _Transition = require('react-transition-group/Transition');

var _Transition2 = _interopRequireDefault(_Transition);

var _portal = require('../../portal');

var _getPosition2 = require('./getPosition');

var _getPosition3 = _interopRequireDefault(_getPosition2);

var _Position = require('./Position');

var _Position2 = _interopRequireDefault(_Position);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var animationEasing = {
  spring: 'cubic-bezier(0.175, 0.885, 0.320, 1.175)'
};

var initialState = function initialState() {
  return {
    top: null,
    left: null,
    transformOrigin: null
  };
};

var getCSS = function getCSS(_ref) {
  var initialScale = _ref.initialScale,
      animationDuration = _ref.animationDuration;
  return {
    position: 'fixed',
    opacity: 0,
    transitionTimingFunction: animationEasing.spring,
    transitionDuration: animationDuration + 'ms',
    transitionProperty: 'opacity, transform',
    transform: 'scale(' + initialScale + ') translateY(-1px)',
    '&[data-state="entering"], &[data-state="entered"]': {
      opacity: 1,
      visibility: 'visible',
      transform: 'scale(1)'
    },
    '&[data-state="exiting"]': {
      opacity: 0,
      transform: 'scale(1)'
    }
  };
};

var Positioner = function (_PureComponent) {
  _inherits(Positioner, _PureComponent);

  function Positioner(props, context) {
    _classCallCheck(this, Positioner);

    var _this = _possibleConstructorReturn(this, (Positioner.__proto__ || Object.getPrototypeOf(Positioner)).call(this, props, context));

    _this.getTargetRef = function (ref) {
      _this.targetRef = ref;
    };

    _this.getRef = function (ref) {
      _this.positionerRef = ref;
      _this.props.innerRef(ref);
    };

    _this.handleEnter = function () {
      _this.update();
    };

    _this.getTargetRect = function () {
      return _this.targetRef.getBoundingClientRect();
    };

    _this.update = function () {
      if (!_this.props.isShown || !_this.targetRef || !_this.positionerRef) return;

      var targetRect = _this.getTargetRect();
      var viewportHeight = document.documentElement.clientHeight + window.scrollY;
      var viewportWidth = document.documentElement.clientWidth + window.scrollX;

      var _getPosition = (0, _getPosition3.default)({
        position: _this.props.position,
        targetRect: targetRect,
        targetOffset: _this.props.targetOffset,
        dimensions: {
          height: _this.positionerRef.offsetHeight,
          width: _this.positionerRef.offsetWidth
        },
        viewport: {
          width: viewportWidth,
          height: viewportHeight
        },
        viewportOffset: _this.props.bodyOffset
      }),
          rect = _getPosition.rect,
          transformOrigin = _getPosition.transformOrigin;

      _this.setState({
        left: rect.left,
        top: rect.top,
        transformOrigin: transformOrigin
      }, function () {
        window.requestAnimationFrame(function () {
          _this.update();
        });
      });
    };

    _this.handleExited = function () {
      _this.setState(function () {
        return _extends({}, initialState());
      }, function () {
        _this.props.onCloseComplete();
      });
    };

    _this.state = initialState();
    return _this;
  }

  _createClass(Positioner, [{
    key: 'render',
    value: function render() {
      var _this2 = this;

      var _props = this.props,
          zIndex = _props.zIndex,
          target = _props.target,
          isShown = _props.isShown,
          children = _props.children,
          initialScale = _props.initialScale,
          targetOffset = _props.targetOffset,
          animationDuration = _props.animationDuration;
      var _state = this.state,
          left = _state.left,
          top = _state.top,
          transformOrigin = _state.transformOrigin;


      return _react2.default.createElement(
        _react2.default.Fragment,
        null,
        target({ getRef: this.getTargetRef, isShown: isShown }),
        _react2.default.createElement(
          _portal.Portal,
          null,
          _react2.default.createElement(
            _Transition2.default,
            {
              'in': isShown,
              timeout: animationDuration,
              onEnter: this.handleEnter,
              onEntered: this.props.onOpenComplete,
              onExited: this.handleExited,
              unmountOnExit: true
            },
            function (state) {
              return children({
                top: top,
                left: left,
                state: state,
                zIndex: zIndex,
                css: getCSS({ targetOffset: targetOffset, initialScale: initialScale, animationDuration: animationDuration }),
                style: {
                  transformOrigin: transformOrigin,
                  left: left,
                  top: top,
                  zIndex: zIndex
                },
                getRef: _this2.getRef,
                animationDuration: animationDuration
              });
            }
          )
        )
      );
    }
  }]);

  return Positioner;
}(_react.PureComponent);

Positioner.propTypes = {
  /**
   * The position the element that is being positioned is on.
   * Smart positioning might override this.
   */
  position: _propTypes2.default.oneOf(Object.keys(_Position2.default)).isRequired,

  /**
   * When true, show the element being positioned.
   */
  isShown: _propTypes2.default.bool,

  /**
   * Function that returns the element being positioned.
   */
  children: _propTypes2.default.func.isRequired,

  /**
   * Function that returns the ref of the element being positioned.
   */
  innerRef: _propTypes2.default.func.isRequired,

  /**
   * The minimum distance from the body to the element being positioned.
   */
  bodyOffset: _propTypes2.default.number.isRequired,

  /**
   * The minimum distance from the target to the element being positioned.
   */
  targetOffset: _propTypes2.default.number.isRequired,

  /**
   * Function that should return a node for the target.
   * ({ getRef: () -> Ref, isShown: Bool }) -> React Node
   */
  target: _propTypes2.default.func.isRequired,

  /**
   * The z-index of the element being positioned.
   */
  zIndex: _propTypes2.default.number.isRequired,

  /**
   * Initial scale of the element being positioned.
   */
  initialScale: _propTypes2.default.number.isRequired,

  /**
   * Duration of the animation.
   */
  animationDuration: _propTypes2.default.number.isRequired,

  /**
   * Function that will be called when the exit transition is complete.
   */
  onCloseComplete: _propTypes2.default.func.isRequired,

  /**
   * Function that will be called when the enter transition is complete.
   */
  onOpenComplete: _propTypes2.default.func.isRequired
};
Positioner.defaultProps = {
  position: _Position2.default.BOTTOM,
  zIndex: 40,
  bodyOffset: 6,
  targetOffset: 6,
  initialScale: 0.9,
  animationDuration: 300,
  innerRef: function innerRef() {},
  onOpenComplete: function onOpenComplete() {},
  onCloseComplete: function onCloseComplete() {}
};
exports.default = Positioner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wb3NpdGlvbmVyL3NyYy9Qb3NpdGlvbmVyLmpzIl0sIm5hbWVzIjpbImFuaW1hdGlvbkVhc2luZyIsInNwcmluZyIsImluaXRpYWxTdGF0ZSIsInRvcCIsImxlZnQiLCJ0cmFuc2Zvcm1PcmlnaW4iLCJnZXRDU1MiLCJpbml0aWFsU2NhbGUiLCJhbmltYXRpb25EdXJhdGlvbiIsInBvc2l0aW9uIiwib3BhY2l0eSIsInRyYW5zaXRpb25UaW1pbmdGdW5jdGlvbiIsInRyYW5zaXRpb25EdXJhdGlvbiIsInRyYW5zaXRpb25Qcm9wZXJ0eSIsInRyYW5zZm9ybSIsInZpc2liaWxpdHkiLCJQb3NpdGlvbmVyIiwicHJvcHMiLCJjb250ZXh0IiwiZ2V0VGFyZ2V0UmVmIiwidGFyZ2V0UmVmIiwicmVmIiwiZ2V0UmVmIiwicG9zaXRpb25lclJlZiIsImlubmVyUmVmIiwiaGFuZGxlRW50ZXIiLCJ1cGRhdGUiLCJnZXRUYXJnZXRSZWN0IiwiZ2V0Qm91bmRpbmdDbGllbnRSZWN0IiwiaXNTaG93biIsInRhcmdldFJlY3QiLCJ2aWV3cG9ydEhlaWdodCIsImRvY3VtZW50IiwiZG9jdW1lbnRFbGVtZW50IiwiY2xpZW50SGVpZ2h0Iiwid2luZG93Iiwic2Nyb2xsWSIsInZpZXdwb3J0V2lkdGgiLCJjbGllbnRXaWR0aCIsInNjcm9sbFgiLCJ0YXJnZXRPZmZzZXQiLCJkaW1lbnNpb25zIiwiaGVpZ2h0Iiwib2Zmc2V0SGVpZ2h0Iiwid2lkdGgiLCJvZmZzZXRXaWR0aCIsInZpZXdwb3J0Iiwidmlld3BvcnRPZmZzZXQiLCJib2R5T2Zmc2V0IiwicmVjdCIsInNldFN0YXRlIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwiaGFuZGxlRXhpdGVkIiwib25DbG9zZUNvbXBsZXRlIiwic3RhdGUiLCJ6SW5kZXgiLCJ0YXJnZXQiLCJjaGlsZHJlbiIsIm9uT3BlbkNvbXBsZXRlIiwiY3NzIiwic3R5bGUiLCJwcm9wVHlwZXMiLCJvbmVPZiIsIk9iamVjdCIsImtleXMiLCJpc1JlcXVpcmVkIiwiYm9vbCIsImZ1bmMiLCJudW1iZXIiLCJkZWZhdWx0UHJvcHMiLCJCT1RUT00iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxrQkFBa0I7QUFDdEJDO0FBRHNCLENBQXhCOztBQUlBLElBQU1DLGVBQWUsU0FBZkEsWUFBZTtBQUFBLFNBQU87QUFDMUJDLFNBQUssSUFEcUI7QUFFMUJDLFVBQU0sSUFGb0I7QUFHMUJDLHFCQUFpQjtBQUhTLEdBQVA7QUFBQSxDQUFyQjs7QUFNQSxJQUFNQyxTQUFTLFNBQVRBLE1BQVM7QUFBQSxNQUFHQyxZQUFILFFBQUdBLFlBQUg7QUFBQSxNQUFpQkMsaUJBQWpCLFFBQWlCQSxpQkFBakI7QUFBQSxTQUEwQztBQUN2REMsY0FBVSxPQUQ2QztBQUV2REMsYUFBUyxDQUY4QztBQUd2REMsOEJBQTBCWCxnQkFBZ0JDLE1BSGE7QUFJdkRXLHdCQUF1QkosaUJBQXZCLE9BSnVEO0FBS3ZESyx3QkFBb0Isb0JBTG1DO0FBTXZEQywwQkFBb0JQLFlBQXBCLHVCQU51RDtBQU92RCx5REFBcUQ7QUFDbkRHLGVBQVMsQ0FEMEM7QUFFbkRLLGtCQUFZLFNBRnVDO0FBR25ERDtBQUhtRCxLQVBFO0FBWXZELCtCQUEyQjtBQUN6QkosZUFBUyxDQURnQjtBQUV6QkksaUJBQVc7QUFGYztBQVo0QixHQUExQztBQUFBLENBQWY7O0lBa0JxQkUsVTs7O0FBNkVuQixzQkFBWUMsS0FBWixFQUFtQkMsT0FBbkIsRUFBNEI7QUFBQTs7QUFBQSx3SEFDcEJELEtBRG9CLEVBQ2JDLE9BRGE7O0FBQUEsVUFLNUJDLFlBTDRCLEdBS2IsZUFBTztBQUNwQixZQUFLQyxTQUFMLEdBQWlCQyxHQUFqQjtBQUNELEtBUDJCOztBQUFBLFVBUzVCQyxNQVQ0QixHQVNuQixlQUFPO0FBQ2QsWUFBS0MsYUFBTCxHQUFxQkYsR0FBckI7QUFDQSxZQUFLSixLQUFMLENBQVdPLFFBQVgsQ0FBb0JILEdBQXBCO0FBQ0QsS0FaMkI7O0FBQUEsVUFjNUJJLFdBZDRCLEdBY2QsWUFBTTtBQUNsQixZQUFLQyxNQUFMO0FBQ0QsS0FoQjJCOztBQUFBLFVBa0I1QkMsYUFsQjRCLEdBa0JaO0FBQUEsYUFBTSxNQUFLUCxTQUFMLENBQWVRLHFCQUFmLEVBQU47QUFBQSxLQWxCWTs7QUFBQSxVQW9CNUJGLE1BcEI0QixHQW9CbkIsWUFBTTtBQUNiLFVBQUksQ0FBQyxNQUFLVCxLQUFMLENBQVdZLE9BQVosSUFBdUIsQ0FBQyxNQUFLVCxTQUE3QixJQUEwQyxDQUFDLE1BQUtHLGFBQXBELEVBQW1FOztBQUVuRSxVQUFNTyxhQUFhLE1BQUtILGFBQUwsRUFBbkI7QUFDQSxVQUFNSSxpQkFDSkMsU0FBU0MsZUFBVCxDQUF5QkMsWUFBekIsR0FBd0NDLE9BQU9DLE9BRGpEO0FBRUEsVUFBTUMsZ0JBQWdCTCxTQUFTQyxlQUFULENBQXlCSyxXQUF6QixHQUF1Q0gsT0FBT0ksT0FBcEU7O0FBTmEseUJBUXFCLDJCQUFZO0FBQzVDOUIsa0JBQVUsTUFBS1EsS0FBTCxDQUFXUixRQUR1QjtBQUU1Q3FCLDhCQUY0QztBQUc1Q1Usc0JBQWMsTUFBS3ZCLEtBQUwsQ0FBV3VCLFlBSG1CO0FBSTVDQyxvQkFBWTtBQUNWQyxrQkFBUSxNQUFLbkIsYUFBTCxDQUFtQm9CLFlBRGpCO0FBRVZDLGlCQUFPLE1BQUtyQixhQUFMLENBQW1Cc0I7QUFGaEIsU0FKZ0M7QUFRNUNDLGtCQUFVO0FBQ1JGLGlCQUFPUCxhQURDO0FBRVJLLGtCQUFRWDtBQUZBLFNBUmtDO0FBWTVDZ0Isd0JBQWdCLE1BQUs5QixLQUFMLENBQVcrQjtBQVppQixPQUFaLENBUnJCO0FBQUEsVUFRTEMsSUFSSyxnQkFRTEEsSUFSSztBQUFBLFVBUUM1QyxlQVJELGdCQVFDQSxlQVJEOztBQXVCYixZQUFLNkMsUUFBTCxDQUNFO0FBQ0U5QyxjQUFNNkMsS0FBSzdDLElBRGI7QUFFRUQsYUFBSzhDLEtBQUs5QyxHQUZaO0FBR0VFO0FBSEYsT0FERixFQU1FLFlBQU07QUFDSjhCLGVBQU9nQixxQkFBUCxDQUE2QixZQUFNO0FBQ2pDLGdCQUFLekIsTUFBTDtBQUNELFNBRkQ7QUFHRCxPQVZIO0FBWUQsS0F2RDJCOztBQUFBLFVBeUQ1QjBCLFlBekQ0QixHQXlEYixZQUFNO0FBQ25CLFlBQUtGLFFBQUwsQ0FDRSxZQUFNO0FBQ0osNEJBQ0toRCxjQURMO0FBR0QsT0FMSCxFQU1FLFlBQU07QUFDSixjQUFLZSxLQUFMLENBQVdvQyxlQUFYO0FBQ0QsT0FSSDtBQVVELEtBcEUyQjs7QUFFMUIsVUFBS0MsS0FBTCxHQUFhcEQsY0FBYjtBQUYwQjtBQUczQjs7Ozs2QkFtRVE7QUFBQTs7QUFBQSxtQkFTSCxLQUFLZSxLQVRGO0FBQUEsVUFFTHNDLE1BRkssVUFFTEEsTUFGSztBQUFBLFVBR0xDLE1BSEssVUFHTEEsTUFISztBQUFBLFVBSUwzQixPQUpLLFVBSUxBLE9BSks7QUFBQSxVQUtMNEIsUUFMSyxVQUtMQSxRQUxLO0FBQUEsVUFNTGxELFlBTkssVUFNTEEsWUFOSztBQUFBLFVBT0xpQyxZQVBLLFVBT0xBLFlBUEs7QUFBQSxVQVFMaEMsaUJBUkssVUFRTEEsaUJBUks7QUFBQSxtQkFXZ0MsS0FBSzhDLEtBWHJDO0FBQUEsVUFXQ2xELElBWEQsVUFXQ0EsSUFYRDtBQUFBLFVBV09ELEdBWFAsVUFXT0EsR0FYUDtBQUFBLFVBV1lFLGVBWFosVUFXWUEsZUFYWjs7O0FBYVAsYUFDRTtBQUFBLHdCQUFPLFFBQVA7QUFBQTtBQUNHbUQsZUFBTyxFQUFFbEMsUUFBUSxLQUFLSCxZQUFmLEVBQTZCVSxnQkFBN0IsRUFBUCxDQURIO0FBRUU7QUFBQTtBQUFBO0FBQ0U7QUFBQTtBQUFBO0FBQ0Usb0JBQUlBLE9BRE47QUFFRSx1QkFBU3JCLGlCQUZYO0FBR0UsdUJBQVMsS0FBS2lCLFdBSGhCO0FBSUUseUJBQVcsS0FBS1IsS0FBTCxDQUFXeUMsY0FKeEI7QUFLRSx3QkFBVSxLQUFLTixZQUxqQjtBQU1FO0FBTkY7QUFRRztBQUFBLHFCQUNDSyxTQUFTO0FBQ1B0RCx3QkFETztBQUVQQywwQkFGTztBQUdQa0QsNEJBSE87QUFJUEMsOEJBSk87QUFLUEkscUJBQUtyRCxPQUFPLEVBQUVrQywwQkFBRixFQUFnQmpDLDBCQUFoQixFQUE4QkMsb0NBQTlCLEVBQVAsQ0FMRTtBQU1Qb0QsdUJBQU87QUFDTHZELGtEQURLO0FBRUxELDRCQUZLO0FBR0xELDBCQUhLO0FBSUxvRDtBQUpLLGlCQU5BO0FBWVBqQyx3QkFBUSxPQUFLQSxNQVpOO0FBYVBkO0FBYk8sZUFBVCxDQUREO0FBQUE7QUFSSDtBQURGO0FBRkYsT0FERjtBQWlDRDs7Ozs7O0FBak1rQlEsVSxDQUNaNkMsUyxHQUFZO0FBQ2pCOzs7O0FBSUFwRCxZQUFVLG9CQUFVcUQsS0FBVixDQUFnQkMsT0FBT0MsSUFBUCxvQkFBaEIsRUFBdUNDLFVBTGhDOztBQU9qQjs7O0FBR0FwQyxXQUFTLG9CQUFVcUMsSUFWRjs7QUFZakI7OztBQUdBVCxZQUFVLG9CQUFVVSxJQUFWLENBQWVGLFVBZlI7O0FBaUJqQjs7O0FBR0F6QyxZQUFVLG9CQUFVMkMsSUFBVixDQUFlRixVQXBCUjs7QUFzQmpCOzs7QUFHQWpCLGNBQVksb0JBQVVvQixNQUFWLENBQWlCSCxVQXpCWjs7QUEyQmpCOzs7QUFHQXpCLGdCQUFjLG9CQUFVNEIsTUFBVixDQUFpQkgsVUE5QmQ7O0FBZ0NqQjs7OztBQUlBVCxVQUFRLG9CQUFVVyxJQUFWLENBQWVGLFVBcENOOztBQXNDakI7OztBQUdBVixVQUFRLG9CQUFVYSxNQUFWLENBQWlCSCxVQXpDUjs7QUEyQ2pCOzs7QUFHQTFELGdCQUFjLG9CQUFVNkQsTUFBVixDQUFpQkgsVUE5Q2Q7O0FBZ0RqQjs7O0FBR0F6RCxxQkFBbUIsb0JBQVU0RCxNQUFWLENBQWlCSCxVQW5EbkI7O0FBcURqQjs7O0FBR0FaLG1CQUFpQixvQkFBVWMsSUFBVixDQUFlRixVQXhEZjs7QUEwRGpCOzs7QUFHQVAsa0JBQWdCLG9CQUFVUyxJQUFWLENBQWVGO0FBN0RkLEM7QUFEQWpELFUsQ0FpRVpxRCxZLEdBQWU7QUFDcEI1RCxZQUFVLG1CQUFTNkQsTUFEQztBQUVwQmYsVUFBUSxFQUZZO0FBR3BCUCxjQUFZLENBSFE7QUFJcEJSLGdCQUFjLENBSk07QUFLcEJqQyxnQkFBYyxHQUxNO0FBTXBCQyxxQkFBbUIsR0FOQztBQU9wQmdCLFlBQVUsb0JBQU0sQ0FBRSxDQVBFO0FBUXBCa0Msa0JBQWdCLDBCQUFNLENBQUUsQ0FSSjtBQVNwQkwsbUJBQWlCLDJCQUFNLENBQUU7QUFUTCxDO2tCQWpFSHJDLFUiLCJmaWxlIjoiUG9zaXRpb25lci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBQdXJlQ29tcG9uZW50IH0gZnJvbSAncmVhY3QnXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnXG5pbXBvcnQgVHJhbnNpdGlvbiBmcm9tICdyZWFjdC10cmFuc2l0aW9uLWdyb3VwL1RyYW5zaXRpb24nXG5pbXBvcnQgeyBQb3J0YWwgfSBmcm9tICcuLi8uLi9wb3J0YWwnXG5pbXBvcnQgZ2V0UG9zaXRpb24gZnJvbSAnLi9nZXRQb3NpdGlvbidcbmltcG9ydCBQb3NpdGlvbiBmcm9tICcuL1Bvc2l0aW9uJ1xuXG5jb25zdCBhbmltYXRpb25FYXNpbmcgPSB7XG4gIHNwcmluZzogYGN1YmljLWJlemllcigwLjE3NSwgMC44ODUsIDAuMzIwLCAxLjE3NSlgXG59XG5cbmNvbnN0IGluaXRpYWxTdGF0ZSA9ICgpID0+ICh7XG4gIHRvcDogbnVsbCxcbiAgbGVmdDogbnVsbCxcbiAgdHJhbnNmb3JtT3JpZ2luOiBudWxsXG59KVxuXG5jb25zdCBnZXRDU1MgPSAoeyBpbml0aWFsU2NhbGUsIGFuaW1hdGlvbkR1cmF0aW9uIH0pID0+ICh7XG4gIHBvc2l0aW9uOiAnZml4ZWQnLFxuICBvcGFjaXR5OiAwLFxuICB0cmFuc2l0aW9uVGltaW5nRnVuY3Rpb246IGFuaW1hdGlvbkVhc2luZy5zcHJpbmcsXG4gIHRyYW5zaXRpb25EdXJhdGlvbjogYCR7YW5pbWF0aW9uRHVyYXRpb259bXNgLFxuICB0cmFuc2l0aW9uUHJvcGVydHk6ICdvcGFjaXR5LCB0cmFuc2Zvcm0nLFxuICB0cmFuc2Zvcm06IGBzY2FsZSgke2luaXRpYWxTY2FsZX0pIHRyYW5zbGF0ZVkoLTFweClgLFxuICAnJltkYXRhLXN0YXRlPVwiZW50ZXJpbmdcIl0sICZbZGF0YS1zdGF0ZT1cImVudGVyZWRcIl0nOiB7XG4gICAgb3BhY2l0eTogMSxcbiAgICB2aXNpYmlsaXR5OiAndmlzaWJsZScsXG4gICAgdHJhbnNmb3JtOiBgc2NhbGUoMSlgXG4gIH0sXG4gICcmW2RhdGEtc3RhdGU9XCJleGl0aW5nXCJdJzoge1xuICAgIG9wYWNpdHk6IDAsXG4gICAgdHJhbnNmb3JtOiAnc2NhbGUoMSknXG4gIH1cbn0pXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBvc2l0aW9uZXIgZXh0ZW5kcyBQdXJlQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICAvKipcbiAgICAgKiBUaGUgcG9zaXRpb24gdGhlIGVsZW1lbnQgdGhhdCBpcyBiZWluZyBwb3NpdGlvbmVkIGlzIG9uLlxuICAgICAqIFNtYXJ0IHBvc2l0aW9uaW5nIG1pZ2h0IG92ZXJyaWRlIHRoaXMuXG4gICAgICovXG4gICAgcG9zaXRpb246IFByb3BUeXBlcy5vbmVPZihPYmplY3Qua2V5cyhQb3NpdGlvbikpLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBXaGVuIHRydWUsIHNob3cgdGhlIGVsZW1lbnQgYmVpbmcgcG9zaXRpb25lZC5cbiAgICAgKi9cbiAgICBpc1Nob3duOiBQcm9wVHlwZXMuYm9vbCxcblxuICAgIC8qKlxuICAgICAqIEZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgZWxlbWVudCBiZWluZyBwb3NpdGlvbmVkLlxuICAgICAqL1xuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogRnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSByZWYgb2YgdGhlIGVsZW1lbnQgYmVpbmcgcG9zaXRpb25lZC5cbiAgICAgKi9cbiAgICBpbm5lclJlZjogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBtaW5pbXVtIGRpc3RhbmNlIGZyb20gdGhlIGJvZHkgdG8gdGhlIGVsZW1lbnQgYmVpbmcgcG9zaXRpb25lZC5cbiAgICAgKi9cbiAgICBib2R5T2Zmc2V0OiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgbWluaW11bSBkaXN0YW5jZSBmcm9tIHRoZSB0YXJnZXQgdG8gdGhlIGVsZW1lbnQgYmVpbmcgcG9zaXRpb25lZC5cbiAgICAgKi9cbiAgICB0YXJnZXRPZmZzZXQ6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIEZ1bmN0aW9uIHRoYXQgc2hvdWxkIHJldHVybiBhIG5vZGUgZm9yIHRoZSB0YXJnZXQuXG4gICAgICogKHsgZ2V0UmVmOiAoKSAtPiBSZWYsIGlzU2hvd246IEJvb2wgfSkgLT4gUmVhY3QgTm9kZVxuICAgICAqL1xuICAgIHRhcmdldDogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIFRoZSB6LWluZGV4IG9mIHRoZSBlbGVtZW50IGJlaW5nIHBvc2l0aW9uZWQuXG4gICAgICovXG4gICAgekluZGV4OiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsIHNjYWxlIG9mIHRoZSBlbGVtZW50IGJlaW5nIHBvc2l0aW9uZWQuXG4gICAgICovXG4gICAgaW5pdGlhbFNjYWxlOiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBEdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uLlxuICAgICAqL1xuICAgIGFuaW1hdGlvbkR1cmF0aW9uOiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIGV4aXQgdHJhbnNpdGlvbiBpcyBjb21wbGV0ZS5cbiAgICAgKi9cbiAgICBvbkNsb3NlQ29tcGxldGU6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIGVudGVyIHRyYW5zaXRpb24gaXMgY29tcGxldGUuXG4gICAgICovXG4gICAgb25PcGVuQ29tcGxldGU6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWRcbiAgfVxuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgcG9zaXRpb246IFBvc2l0aW9uLkJPVFRPTSxcbiAgICB6SW5kZXg6IDQwLFxuICAgIGJvZHlPZmZzZXQ6IDYsXG4gICAgdGFyZ2V0T2Zmc2V0OiA2LFxuICAgIGluaXRpYWxTY2FsZTogMC45LFxuICAgIGFuaW1hdGlvbkR1cmF0aW9uOiAzMDAsXG4gICAgaW5uZXJSZWY6ICgpID0+IHt9LFxuICAgIG9uT3BlbkNvbXBsZXRlOiAoKSA9PiB7fSxcbiAgICBvbkNsb3NlQ29tcGxldGU6ICgpID0+IHt9XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm9wcywgY29udGV4dCkge1xuICAgIHN1cGVyKHByb3BzLCBjb250ZXh0KVxuICAgIHRoaXMuc3RhdGUgPSBpbml0aWFsU3RhdGUoKVxuICB9XG5cbiAgZ2V0VGFyZ2V0UmVmID0gcmVmID0+IHtcbiAgICB0aGlzLnRhcmdldFJlZiA9IHJlZlxuICB9XG5cbiAgZ2V0UmVmID0gcmVmID0+IHtcbiAgICB0aGlzLnBvc2l0aW9uZXJSZWYgPSByZWZcbiAgICB0aGlzLnByb3BzLmlubmVyUmVmKHJlZilcbiAgfVxuXG4gIGhhbmRsZUVudGVyID0gKCkgPT4ge1xuICAgIHRoaXMudXBkYXRlKClcbiAgfVxuXG4gIGdldFRhcmdldFJlY3QgPSAoKSA9PiB0aGlzLnRhcmdldFJlZi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuXG4gIHVwZGF0ZSA9ICgpID0+IHtcbiAgICBpZiAoIXRoaXMucHJvcHMuaXNTaG93biB8fCAhdGhpcy50YXJnZXRSZWYgfHwgIXRoaXMucG9zaXRpb25lclJlZikgcmV0dXJuXG5cbiAgICBjb25zdCB0YXJnZXRSZWN0ID0gdGhpcy5nZXRUYXJnZXRSZWN0KClcbiAgICBjb25zdCB2aWV3cG9ydEhlaWdodCA9XG4gICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0ICsgd2luZG93LnNjcm9sbFlcbiAgICBjb25zdCB2aWV3cG9ydFdpZHRoID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoICsgd2luZG93LnNjcm9sbFhcblxuICAgIGNvbnN0IHsgcmVjdCwgdHJhbnNmb3JtT3JpZ2luIH0gPSBnZXRQb3NpdGlvbih7XG4gICAgICBwb3NpdGlvbjogdGhpcy5wcm9wcy5wb3NpdGlvbixcbiAgICAgIHRhcmdldFJlY3QsXG4gICAgICB0YXJnZXRPZmZzZXQ6IHRoaXMucHJvcHMudGFyZ2V0T2Zmc2V0LFxuICAgICAgZGltZW5zaW9uczoge1xuICAgICAgICBoZWlnaHQ6IHRoaXMucG9zaXRpb25lclJlZi5vZmZzZXRIZWlnaHQsXG4gICAgICAgIHdpZHRoOiB0aGlzLnBvc2l0aW9uZXJSZWYub2Zmc2V0V2lkdGhcbiAgICAgIH0sXG4gICAgICB2aWV3cG9ydDoge1xuICAgICAgICB3aWR0aDogdmlld3BvcnRXaWR0aCxcbiAgICAgICAgaGVpZ2h0OiB2aWV3cG9ydEhlaWdodFxuICAgICAgfSxcbiAgICAgIHZpZXdwb3J0T2Zmc2V0OiB0aGlzLnByb3BzLmJvZHlPZmZzZXRcbiAgICB9KVxuXG4gICAgdGhpcy5zZXRTdGF0ZShcbiAgICAgIHtcbiAgICAgICAgbGVmdDogcmVjdC5sZWZ0LFxuICAgICAgICB0b3A6IHJlY3QudG9wLFxuICAgICAgICB0cmFuc2Zvcm1PcmlnaW5cbiAgICAgIH0sXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICAgIHRoaXMudXBkYXRlKClcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICApXG4gIH1cblxuICBoYW5kbGVFeGl0ZWQgPSAoKSA9PiB7XG4gICAgdGhpcy5zZXRTdGF0ZShcbiAgICAgICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAuLi5pbml0aWFsU3RhdGUoKVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgKCkgPT4ge1xuICAgICAgICB0aGlzLnByb3BzLm9uQ2xvc2VDb21wbGV0ZSgpXG4gICAgICB9XG4gICAgKVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHpJbmRleCxcbiAgICAgIHRhcmdldCxcbiAgICAgIGlzU2hvd24sXG4gICAgICBjaGlsZHJlbixcbiAgICAgIGluaXRpYWxTY2FsZSxcbiAgICAgIHRhcmdldE9mZnNldCxcbiAgICAgIGFuaW1hdGlvbkR1cmF0aW9uXG4gICAgfSA9IHRoaXMucHJvcHNcblxuICAgIGNvbnN0IHsgbGVmdCwgdG9wLCB0cmFuc2Zvcm1PcmlnaW4gfSA9IHRoaXMuc3RhdGVcblxuICAgIHJldHVybiAoXG4gICAgICA8UmVhY3QuRnJhZ21lbnQ+XG4gICAgICAgIHt0YXJnZXQoeyBnZXRSZWY6IHRoaXMuZ2V0VGFyZ2V0UmVmLCBpc1Nob3duIH0pfVxuICAgICAgICA8UG9ydGFsPlxuICAgICAgICAgIDxUcmFuc2l0aW9uXG4gICAgICAgICAgICBpbj17aXNTaG93bn1cbiAgICAgICAgICAgIHRpbWVvdXQ9e2FuaW1hdGlvbkR1cmF0aW9ufVxuICAgICAgICAgICAgb25FbnRlcj17dGhpcy5oYW5kbGVFbnRlcn1cbiAgICAgICAgICAgIG9uRW50ZXJlZD17dGhpcy5wcm9wcy5vbk9wZW5Db21wbGV0ZX1cbiAgICAgICAgICAgIG9uRXhpdGVkPXt0aGlzLmhhbmRsZUV4aXRlZH1cbiAgICAgICAgICAgIHVubW91bnRPbkV4aXRcbiAgICAgICAgICA+XG4gICAgICAgICAgICB7c3RhdGUgPT5cbiAgICAgICAgICAgICAgY2hpbGRyZW4oe1xuICAgICAgICAgICAgICAgIHRvcCxcbiAgICAgICAgICAgICAgICBsZWZ0LFxuICAgICAgICAgICAgICAgIHN0YXRlLFxuICAgICAgICAgICAgICAgIHpJbmRleCxcbiAgICAgICAgICAgICAgICBjc3M6IGdldENTUyh7IHRhcmdldE9mZnNldCwgaW5pdGlhbFNjYWxlLCBhbmltYXRpb25EdXJhdGlvbiB9KSxcbiAgICAgICAgICAgICAgICBzdHlsZToge1xuICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtT3JpZ2luLFxuICAgICAgICAgICAgICAgICAgbGVmdCxcbiAgICAgICAgICAgICAgICAgIHRvcCxcbiAgICAgICAgICAgICAgICAgIHpJbmRleFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZ2V0UmVmOiB0aGlzLmdldFJlZixcbiAgICAgICAgICAgICAgICBhbmltYXRpb25EdXJhdGlvblxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIDwvVHJhbnNpdGlvbj5cbiAgICAgICAgPC9Qb3J0YWw+XG4gICAgICA8L1JlYWN0LkZyYWdtZW50PlxuICAgIClcbiAgfVxufVxuIl19