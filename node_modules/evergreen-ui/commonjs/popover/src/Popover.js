'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _positioner = require('../../positioner');

var _PopoverStateless = require('./PopoverStateless');

var _PopoverStateless2 = _interopRequireDefault(_PopoverStateless);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var Popover = function (_Component) {
  _inherits(Popover, _Component);

  function Popover(props) {
    _classCallCheck(this, Popover);

    var _this = _possibleConstructorReturn(this, (Popover.__proto__ || Object.getPrototypeOf(Popover)).call(this, props));

    _this.bringFocusInside = function () {
      if (!_this.props.bringFocusInside) return;

      // Always delay focus manipulation to just before repaint to prevent scroll jumping
      return requestAnimationFrame(function () {
        // Container ref may be undefined between component mounting and Portal rendering
        // activeElement may be undefined in some rare cases in IE

        if (_this.popoverNode == null || // eslint-disable-line eqeqeq, no-eq-null
        document.activeElement == null || // eslint-disable-line eqeqeq, no-eq-null
        !_this.props.isShown) {
          return;
        }

        var isFocusOutsideModal = !_this.popoverNode.contains(document.activeElement);
        if (isFocusOutsideModal) {
          // Element marked autofocus has higher priority than the other clowns
          var autofocusElement = _this.popoverNode.querySelector('[autofocus]');
          var wrapperElement = _this.popoverNode.querySelector('[tabindex]');
          var buttonElement = _this.popoverNode.querySelector('button');

          if (autofocusElement) {
            autofocusElement.focus();
          } else if (wrapperElement) {
            wrapperElement.focus();
          } else if (buttonElement) {
            buttonElement.focus();
          }
        }
      });
    };

    _this.bringFocusBackToTarget = function () {
      return requestAnimationFrame(function () {
        if (_this.popoverNode == null || // eslint-disable-line eqeqeq, no-eq-null
        document.activeElement == null // eslint-disable-line eqeqeq, no-eq-null
        ) {
            return;
          }

        var isFocusInsideModal = _this.popoverNode.contains(document.activeElement);

        // Bring back focus on the target.
        if (_this.targetRef && (document.activeElement === document.body || isFocusInsideModal)) {
          _this.targetRef.focus();
        }
      });
    };

    _this.onBodyClick = function (e) {
      // Ignore clicks on the popover or button
      if (_this.targetRef === e.target) {
        return;
      }

      if (_this.popoverNode && (_this.popoverNode === e.target || _this.popoverNode.contains(e.target))) {
        return;
      }

      _this.close();
    };

    _this.onEsc = function (e) {
      // Esc key
      if (e.keyCode === 27) {
        _this.close();
      }
    };

    _this.toggle = function () {
      if (_this.state.isShown) {
        _this.close();
      } else {
        _this.open();
      }
    };

    _this.open = function () {
      if (_this.state.isShown) {
        return;
      }

      _this.setState({ isShown: true });
      document.body.addEventListener('click', _this.onBodyClick, false);
      document.body.addEventListener('keydown', _this.onEsc, false);

      _this.props.onOpen();
    };

    _this.close = function () {
      if (!_this.state.isShown) {
        return;
      }

      _this.setState({ isShown: false });
      document.body.removeEventListener('click', _this.onBodyClick, false);
      document.body.removeEventListener('keydown', _this.onEsc, false);

      _this.bringFocusBackToTarget();

      _this.props.onClose();
    };

    _this.handleOpenComplete = function () {
      _this.bringFocusInside();
      _this.props.onOpenComplete();
    };

    _this.handleCloseComplete = function () {
      _this.props.onCloseComplete();
    };

    _this.renderTarget = function (_ref) {
      var getRef = _ref.getRef,
          isShown = _ref.isShown;
      var children = _this.props.children;


      var getTargetRef = function getTargetRef(ref) {
        _this.targetRef = ref;
        getRef(ref);
      };

      if (typeof children === 'function') {
        return children({
          toggle: _this.toggle,
          getRef: getTargetRef,
          isShown: isShown
        });
      }

      return _react2.default.cloneElement(children, {
        onClick: _this.toggle,
        innerRef: getTargetRef,
        role: 'button',
        'aria-expanded': isShown,
        'aria-haspopup': true
      });
    };

    _this.state = {
      isShown: props.isShown
    };
    return _this;
  }

  _createClass(Popover, [{
    key: 'componentWillUnmount',
    value: function componentWillUnmount() {
      document.body.removeEventListener('click', this.onBodyClick, false);
      document.body.removeEventListener('keydown', this.onEsc, false);
    }

    /**
     * Methods borrowed from BlueprintJS
     * https://github.com/palantir/blueprint/blob/release/2.0.0/packages/core/src/components/overlay/overlay.tsx
     */

  }, {
    key: 'render',
    value: function render() {
      var _this2 = this;

      var _props = this.props,
          zIndex = _props.zIndex,
          isShown = _props.isShown,
          content = _props.content,
          display = _props.display,
          minWidth = _props.minWidth,
          position = _props.position,
          minHeight = _props.minHeight,
          statelessProps = _props.statelessProps,
          animationDuration = _props.animationDuration,
          onCloseComplete = _props.onCloseComplete;
      var stateIsShown = this.state.isShown;


      var shown = isShown || stateIsShown;

      return _react2.default.createElement(
        _positioner.Positioner,
        {
          target: function target(_ref2) {
            var getRef = _ref2.getRef,
                isShown = _ref2.isShown,
                targetWidth = _ref2.targetWidth;

            return _this2.renderTarget({ getRef: getRef, isShown: isShown, targetWidth: targetWidth });
          },
          zIndex: zIndex,
          isShown: shown,
          position: position,
          animationDuration: animationDuration,
          onOpenComplete: this.handleOpenComplete,
          onCloseComplete: onCloseComplete
        },
        function (_ref3) {
          var css = _ref3.css,
              style = _ref3.style,
              state = _ref3.state,
              getRef = _ref3.getRef;
          return _react2.default.createElement(
            _PopoverStateless2.default,
            _extends({
              innerRef: function innerRef(ref) {
                _this2.popoverNode = ref;
                getRef(ref);
              },
              'data-state': state,
              css: css,
              style: style,
              display: display,
              minWidth: minWidth,
              minHeight: minHeight
            }, statelessProps),
            typeof content === 'function' ? content({ close: _this2.close }) : content
          );
        }
      );
    }
  }]);

  return Popover;
}(_react.Component);

Popover.propTypes = {
  /**
   * The position the Popover is on. Smart positioning might override this.
   */
  position: _propTypes2.default.oneOf(Object.keys(_positioner.Position)),

  /**
   * When true, the Popover is manually shown.
   */
  isShown: _propTypes2.default.bool,

  /**
   * The content of the Popover.
   */
  content: _propTypes2.default.oneOfType([_propTypes2.default.node, _propTypes2.default.func]).isRequired,

  /**
   * The target button of the Popover.
   * When a function the following arguments are passed:
   * ({ toggle: Function -> Void, getRef: Function -> Ref, isShown: Bool })
   */
  children: _propTypes2.default.oneOfType([_propTypes2.default.element, _propTypes2.default.func]).isRequired,

  /**
   * The display property passed to the Popover card.
   */
  display: _propTypes2.default.string,

  /**
   * The min width of the Popover card.
   */
  minWidth: _propTypes2.default.oneOfType([_propTypes2.default.number, _propTypes2.default.string]),

  /**
   * The min height of the Popover card.
   */
  minHeight: _propTypes2.default.oneOfType([_propTypes2.default.number, _propTypes2.default.string]),

  /**
   * Properties passed through to the Popover card.
   */
  statelessProps: _propTypes2.default.objectOf(_PopoverStateless2.default.propTypes),

  /**
   * Duration of the animation.
   */
  animationDuration: _propTypes2.default.number,

  /**
   * The z-index of the Popover card.
   */
  zIndex: _propTypes2.default.number,

  /**
   * Function called when the Popover opens.
   */
  onOpen: _propTypes2.default.func.isRequired,

  /**
   * Function fired when Popover closes.
   */
  onClose: _propTypes2.default.func.isRequired,

  /**
   * Function that will be called when the enter transition is complete.
   */
  onOpenComplete: _propTypes2.default.func.isRequired,

  /**
   * Function that will be called when the exit transition is complete.
   */
  onCloseComplete: _propTypes2.default.func.isRequired,

  /**
   * When true, bring focus inside of the Popover on open.
   */
  bringFocusInside: _propTypes2.default.bool
};
Popover.defaultProps = {
  position: _positioner.Position.BOTTOM,
  isShown: false,
  minWidth: 200,
  minHeight: 40,
  animationDuration: 300,
  zIndex: 40,
  onOpen: function onOpen() {},
  onClose: function onClose() {},
  onOpenComplete: function onOpenComplete() {},
  onCloseComplete: function onCloseComplete() {},
  bringFocusInside: true
};
exports.default = Popover;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wb3BvdmVyL3NyYy9Qb3BvdmVyLmpzIl0sIm5hbWVzIjpbIlBvcG92ZXIiLCJwcm9wcyIsImJyaW5nRm9jdXNJbnNpZGUiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJwb3BvdmVyTm9kZSIsImRvY3VtZW50IiwiYWN0aXZlRWxlbWVudCIsImlzU2hvd24iLCJpc0ZvY3VzT3V0c2lkZU1vZGFsIiwiY29udGFpbnMiLCJhdXRvZm9jdXNFbGVtZW50IiwicXVlcnlTZWxlY3RvciIsIndyYXBwZXJFbGVtZW50IiwiYnV0dG9uRWxlbWVudCIsImZvY3VzIiwiYnJpbmdGb2N1c0JhY2tUb1RhcmdldCIsImlzRm9jdXNJbnNpZGVNb2RhbCIsInRhcmdldFJlZiIsImJvZHkiLCJvbkJvZHlDbGljayIsImUiLCJ0YXJnZXQiLCJjbG9zZSIsIm9uRXNjIiwia2V5Q29kZSIsInRvZ2dsZSIsInN0YXRlIiwib3BlbiIsInNldFN0YXRlIiwiYWRkRXZlbnRMaXN0ZW5lciIsIm9uT3BlbiIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJvbkNsb3NlIiwiaGFuZGxlT3BlbkNvbXBsZXRlIiwib25PcGVuQ29tcGxldGUiLCJoYW5kbGVDbG9zZUNvbXBsZXRlIiwib25DbG9zZUNvbXBsZXRlIiwicmVuZGVyVGFyZ2V0IiwiZ2V0UmVmIiwiY2hpbGRyZW4iLCJnZXRUYXJnZXRSZWYiLCJyZWYiLCJjbG9uZUVsZW1lbnQiLCJvbkNsaWNrIiwiaW5uZXJSZWYiLCJyb2xlIiwiekluZGV4IiwiY29udGVudCIsImRpc3BsYXkiLCJtaW5XaWR0aCIsInBvc2l0aW9uIiwibWluSGVpZ2h0Iiwic3RhdGVsZXNzUHJvcHMiLCJhbmltYXRpb25EdXJhdGlvbiIsInN0YXRlSXNTaG93biIsInNob3duIiwidGFyZ2V0V2lkdGgiLCJjc3MiLCJzdHlsZSIsInByb3BUeXBlcyIsIm9uZU9mIiwiT2JqZWN0Iiwia2V5cyIsImJvb2wiLCJvbmVPZlR5cGUiLCJub2RlIiwiZnVuYyIsImlzUmVxdWlyZWQiLCJlbGVtZW50Iiwic3RyaW5nIiwibnVtYmVyIiwib2JqZWN0T2YiLCJkZWZhdWx0UHJvcHMiLCJCT1RUT00iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7OztJQUVxQkEsTzs7O0FBK0ZuQixtQkFBWUMsS0FBWixFQUFtQjtBQUFBOztBQUFBLGtIQUNYQSxLQURXOztBQUFBLFVBZ0JuQkMsZ0JBaEJtQixHQWdCQSxZQUFNO0FBQ3ZCLFVBQUksQ0FBQyxNQUFLRCxLQUFMLENBQVdDLGdCQUFoQixFQUFrQzs7QUFFbEM7QUFDQSxhQUFPQyxzQkFBc0IsWUFBTTtBQUNqQztBQUNBOztBQUVBLFlBQ0UsTUFBS0MsV0FBTCxJQUFvQixJQUFwQixJQUE0QjtBQUM1QkMsaUJBQVNDLGFBQVQsSUFBMEIsSUFEMUIsSUFDa0M7QUFDbEMsU0FBQyxNQUFLTCxLQUFMLENBQVdNLE9BSGQsRUFJRTtBQUNBO0FBQ0Q7O0FBRUQsWUFBTUMsc0JBQXNCLENBQUMsTUFBS0osV0FBTCxDQUFpQkssUUFBakIsQ0FDM0JKLFNBQVNDLGFBRGtCLENBQTdCO0FBR0EsWUFBSUUsbUJBQUosRUFBeUI7QUFDdkI7QUFDQSxjQUFNRSxtQkFBbUIsTUFBS04sV0FBTCxDQUFpQk8sYUFBakIsQ0FBK0IsYUFBL0IsQ0FBekI7QUFDQSxjQUFNQyxpQkFBaUIsTUFBS1IsV0FBTCxDQUFpQk8sYUFBakIsQ0FBK0IsWUFBL0IsQ0FBdkI7QUFDQSxjQUFNRSxnQkFBZ0IsTUFBS1QsV0FBTCxDQUFpQk8sYUFBakIsQ0FBK0IsUUFBL0IsQ0FBdEI7O0FBRUEsY0FBSUQsZ0JBQUosRUFBc0I7QUFDcEJBLDZCQUFpQkksS0FBakI7QUFDRCxXQUZELE1BRU8sSUFBSUYsY0FBSixFQUFvQjtBQUN6QkEsMkJBQWVFLEtBQWY7QUFDRCxXQUZNLE1BRUEsSUFBSUQsYUFBSixFQUFtQjtBQUN4QkEsMEJBQWNDLEtBQWQ7QUFDRDtBQUNGO0FBQ0YsT0E3Qk0sQ0FBUDtBQThCRCxLQWxEa0I7O0FBQUEsVUFvRG5CQyxzQkFwRG1CLEdBb0RNLFlBQU07QUFDN0IsYUFBT1osc0JBQXNCLFlBQU07QUFDakMsWUFDRSxNQUFLQyxXQUFMLElBQW9CLElBQXBCLElBQTRCO0FBQzVCQyxpQkFBU0MsYUFBVCxJQUEwQixJQUY1QixDQUVpQztBQUZqQyxVQUdFO0FBQ0E7QUFDRDs7QUFFRCxZQUFNVSxxQkFBcUIsTUFBS1osV0FBTCxDQUFpQkssUUFBakIsQ0FDekJKLFNBQVNDLGFBRGdCLENBQTNCOztBQUlBO0FBQ0EsWUFDRSxNQUFLVyxTQUFMLEtBQ0NaLFNBQVNDLGFBQVQsS0FBMkJELFNBQVNhLElBQXBDLElBQTRDRixrQkFEN0MsQ0FERixFQUdFO0FBQ0EsZ0JBQUtDLFNBQUwsQ0FBZUgsS0FBZjtBQUNEO0FBQ0YsT0FuQk0sQ0FBUDtBQW9CRCxLQXpFa0I7O0FBQUEsVUEyRW5CSyxXQTNFbUIsR0EyRUwsYUFBSztBQUNqQjtBQUNBLFVBQUksTUFBS0YsU0FBTCxLQUFtQkcsRUFBRUMsTUFBekIsRUFBaUM7QUFDL0I7QUFDRDs7QUFFRCxVQUNFLE1BQUtqQixXQUFMLEtBQ0MsTUFBS0EsV0FBTCxLQUFxQmdCLEVBQUVDLE1BQXZCLElBQWlDLE1BQUtqQixXQUFMLENBQWlCSyxRQUFqQixDQUEwQlcsRUFBRUMsTUFBNUIsQ0FEbEMsQ0FERixFQUdFO0FBQ0E7QUFDRDs7QUFFRCxZQUFLQyxLQUFMO0FBQ0QsS0F6RmtCOztBQUFBLFVBMkZuQkMsS0EzRm1CLEdBMkZYLGFBQUs7QUFDWDtBQUNBLFVBQUlILEVBQUVJLE9BQUYsS0FBYyxFQUFsQixFQUFzQjtBQUNwQixjQUFLRixLQUFMO0FBQ0Q7QUFDRixLQWhHa0I7O0FBQUEsVUFrR25CRyxNQWxHbUIsR0FrR1YsWUFBTTtBQUNiLFVBQUksTUFBS0MsS0FBTCxDQUFXbkIsT0FBZixFQUF3QjtBQUN0QixjQUFLZSxLQUFMO0FBQ0QsT0FGRCxNQUVPO0FBQ0wsY0FBS0ssSUFBTDtBQUNEO0FBQ0YsS0F4R2tCOztBQUFBLFVBMEduQkEsSUExR21CLEdBMEdaLFlBQU07QUFDWCxVQUFJLE1BQUtELEtBQUwsQ0FBV25CLE9BQWYsRUFBd0I7QUFDdEI7QUFDRDs7QUFFRCxZQUFLcUIsUUFBTCxDQUFjLEVBQUVyQixTQUFTLElBQVgsRUFBZDtBQUNBRixlQUFTYSxJQUFULENBQWNXLGdCQUFkLENBQStCLE9BQS9CLEVBQXdDLE1BQUtWLFdBQTdDLEVBQTBELEtBQTFEO0FBQ0FkLGVBQVNhLElBQVQsQ0FBY1csZ0JBQWQsQ0FBK0IsU0FBL0IsRUFBMEMsTUFBS04sS0FBL0MsRUFBc0QsS0FBdEQ7O0FBRUEsWUFBS3RCLEtBQUwsQ0FBVzZCLE1BQVg7QUFDRCxLQXBIa0I7O0FBQUEsVUFzSG5CUixLQXRIbUIsR0FzSFgsWUFBTTtBQUNaLFVBQUksQ0FBQyxNQUFLSSxLQUFMLENBQVduQixPQUFoQixFQUF5QjtBQUN2QjtBQUNEOztBQUVELFlBQUtxQixRQUFMLENBQWMsRUFBRXJCLFNBQVMsS0FBWCxFQUFkO0FBQ0FGLGVBQVNhLElBQVQsQ0FBY2EsbUJBQWQsQ0FBa0MsT0FBbEMsRUFBMkMsTUFBS1osV0FBaEQsRUFBNkQsS0FBN0Q7QUFDQWQsZUFBU2EsSUFBVCxDQUFjYSxtQkFBZCxDQUFrQyxTQUFsQyxFQUE2QyxNQUFLUixLQUFsRCxFQUF5RCxLQUF6RDs7QUFFQSxZQUFLUixzQkFBTDs7QUFFQSxZQUFLZCxLQUFMLENBQVcrQixPQUFYO0FBQ0QsS0FsSWtCOztBQUFBLFVBb0luQkMsa0JBcEltQixHQW9JRSxZQUFNO0FBQ3pCLFlBQUsvQixnQkFBTDtBQUNBLFlBQUtELEtBQUwsQ0FBV2lDLGNBQVg7QUFDRCxLQXZJa0I7O0FBQUEsVUF5SW5CQyxtQkF6SW1CLEdBeUlHLFlBQU07QUFDMUIsWUFBS2xDLEtBQUwsQ0FBV21DLGVBQVg7QUFDRCxLQTNJa0I7O0FBQUEsVUE2SW5CQyxZQTdJbUIsR0E2SUosZ0JBQXlCO0FBQUEsVUFBdEJDLE1BQXNCLFFBQXRCQSxNQUFzQjtBQUFBLFVBQWQvQixPQUFjLFFBQWRBLE9BQWM7QUFBQSxVQUM5QmdDLFFBRDhCLEdBQ2pCLE1BQUt0QyxLQURZLENBQzlCc0MsUUFEOEI7OztBQUd0QyxVQUFNQyxlQUFlLFNBQWZBLFlBQWUsTUFBTztBQUMxQixjQUFLdkIsU0FBTCxHQUFpQndCLEdBQWpCO0FBQ0FILGVBQU9HLEdBQVA7QUFDRCxPQUhEOztBQUtBLFVBQUksT0FBT0YsUUFBUCxLQUFvQixVQUF4QixFQUFvQztBQUNsQyxlQUFPQSxTQUFTO0FBQ2RkLGtCQUFRLE1BQUtBLE1BREM7QUFFZGEsa0JBQVFFLFlBRk07QUFHZGpDO0FBSGMsU0FBVCxDQUFQO0FBS0Q7O0FBRUQsYUFBTyxnQkFBTW1DLFlBQU4sQ0FBbUJILFFBQW5CLEVBQTZCO0FBQ2xDSSxpQkFBUyxNQUFLbEIsTUFEb0I7QUFFbENtQixrQkFBVUosWUFGd0I7QUFHbENLLGNBQU0sUUFINEI7QUFJbEMseUJBQWlCdEMsT0FKaUI7QUFLbEMseUJBQWlCO0FBTGlCLE9BQTdCLENBQVA7QUFPRCxLQXBLa0I7O0FBRWpCLFVBQUttQixLQUFMLEdBQWE7QUFDWG5CLGVBQVNOLE1BQU1NO0FBREosS0FBYjtBQUZpQjtBQUtsQjs7OzsyQ0FFc0I7QUFDckJGLGVBQVNhLElBQVQsQ0FBY2EsbUJBQWQsQ0FBa0MsT0FBbEMsRUFBMkMsS0FBS1osV0FBaEQsRUFBNkQsS0FBN0Q7QUFDQWQsZUFBU2EsSUFBVCxDQUFjYSxtQkFBZCxDQUFrQyxTQUFsQyxFQUE2QyxLQUFLUixLQUFsRCxFQUF5RCxLQUF6RDtBQUNEOztBQUVEOzs7Ozs7OzZCQTBKUztBQUFBOztBQUFBLG1CQVlILEtBQUt0QixLQVpGO0FBQUEsVUFFTDZDLE1BRkssVUFFTEEsTUFGSztBQUFBLFVBR0x2QyxPQUhLLFVBR0xBLE9BSEs7QUFBQSxVQUlMd0MsT0FKSyxVQUlMQSxPQUpLO0FBQUEsVUFLTEMsT0FMSyxVQUtMQSxPQUxLO0FBQUEsVUFNTEMsUUFOSyxVQU1MQSxRQU5LO0FBQUEsVUFPTEMsUUFQSyxVQU9MQSxRQVBLO0FBQUEsVUFRTEMsU0FSSyxVQVFMQSxTQVJLO0FBQUEsVUFTTEMsY0FUSyxVQVNMQSxjQVRLO0FBQUEsVUFVTEMsaUJBVkssVUFVTEEsaUJBVks7QUFBQSxVQVdMakIsZUFYSyxVQVdMQSxlQVhLO0FBQUEsVUFhVWtCLFlBYlYsR0FhMkIsS0FBSzVCLEtBYmhDLENBYUNuQixPQWJEOzs7QUFlUCxVQUFNZ0QsUUFBUWhELFdBQVcrQyxZQUF6Qjs7QUFFQSxhQUNFO0FBQUE7QUFBQTtBQUNFLGtCQUFRLHVCQUFzQztBQUFBLGdCQUFuQ2hCLE1BQW1DLFNBQW5DQSxNQUFtQztBQUFBLGdCQUEzQi9CLE9BQTJCLFNBQTNCQSxPQUEyQjtBQUFBLGdCQUFsQmlELFdBQWtCLFNBQWxCQSxXQUFrQjs7QUFDNUMsbUJBQU8sT0FBS25CLFlBQUwsQ0FBa0IsRUFBRUMsY0FBRixFQUFVL0IsZ0JBQVYsRUFBbUJpRCx3QkFBbkIsRUFBbEIsQ0FBUDtBQUNELFdBSEg7QUFJRSxrQkFBUVYsTUFKVjtBQUtFLG1CQUFTUyxLQUxYO0FBTUUsb0JBQVVMLFFBTlo7QUFPRSw2QkFBbUJHLGlCQVByQjtBQVFFLDBCQUFnQixLQUFLcEIsa0JBUnZCO0FBU0UsMkJBQWlCRztBQVRuQjtBQVdHO0FBQUEsY0FBR3FCLEdBQUgsU0FBR0EsR0FBSDtBQUFBLGNBQVFDLEtBQVIsU0FBUUEsS0FBUjtBQUFBLGNBQWVoQyxLQUFmLFNBQWVBLEtBQWY7QUFBQSxjQUFzQlksTUFBdEIsU0FBc0JBLE1BQXRCO0FBQUEsaUJBQ0M7QUFBQTtBQUFBO0FBQ0Usd0JBQVUsdUJBQU87QUFDZix1QkFBS2xDLFdBQUwsR0FBbUJxQyxHQUFuQjtBQUNBSCx1QkFBT0csR0FBUDtBQUNELGVBSkg7QUFLRSw0QkFBWWYsS0FMZDtBQU1FLG1CQUFLK0IsR0FOUDtBQU9FLHFCQUFPQyxLQVBUO0FBUUUsdUJBQVNWLE9BUlg7QUFTRSx3QkFBVUMsUUFUWjtBQVVFLHlCQUFXRTtBQVZiLGVBV01DLGNBWE47QUFhRyxtQkFBT0wsT0FBUCxLQUFtQixVQUFuQixHQUNHQSxRQUFRLEVBQUV6QixPQUFPLE9BQUtBLEtBQWQsRUFBUixDQURILEdBRUd5QjtBQWZOLFdBREQ7QUFBQTtBQVhILE9BREY7QUFpQ0Q7Ozs7OztBQXZUa0IvQyxPLENBQ1oyRCxTLEdBQVk7QUFDakI7OztBQUdBVCxZQUFVLG9CQUFVVSxLQUFWLENBQWdCQyxPQUFPQyxJQUFQLHNCQUFoQixDQUpPOztBQU1qQjs7O0FBR0F2RCxXQUFTLG9CQUFVd0QsSUFURjs7QUFXakI7OztBQUdBaEIsV0FBUyxvQkFBVWlCLFNBQVYsQ0FBb0IsQ0FBQyxvQkFBVUMsSUFBWCxFQUFpQixvQkFBVUMsSUFBM0IsQ0FBcEIsRUFBc0RDLFVBZDlDOztBQWdCakI7Ozs7O0FBS0E1QixZQUFVLG9CQUFVeUIsU0FBVixDQUFvQixDQUFDLG9CQUFVSSxPQUFYLEVBQW9CLG9CQUFVRixJQUE5QixDQUFwQixFQUNQQyxVQXRCYzs7QUF3QmpCOzs7QUFHQW5CLFdBQVMsb0JBQVVxQixNQTNCRjs7QUE2QmpCOzs7QUFHQXBCLFlBQVUsb0JBQVVlLFNBQVYsQ0FBb0IsQ0FBQyxvQkFBVU0sTUFBWCxFQUFtQixvQkFBVUQsTUFBN0IsQ0FBcEIsQ0FoQ087O0FBa0NqQjs7O0FBR0FsQixhQUFXLG9CQUFVYSxTQUFWLENBQW9CLENBQUMsb0JBQVVNLE1BQVgsRUFBbUIsb0JBQVVELE1BQTdCLENBQXBCLENBckNNOztBQXVDakI7OztBQUdBakIsa0JBQWdCLG9CQUFVbUIsUUFBVixDQUFtQiwyQkFBaUJaLFNBQXBDLENBMUNDOztBQTRDakI7OztBQUdBTixxQkFBbUIsb0JBQVVpQixNQS9DWjs7QUFpRGpCOzs7QUFHQXhCLFVBQVEsb0JBQVV3QixNQXBERDs7QUFzRGpCOzs7QUFHQXhDLFVBQVEsb0JBQVVvQyxJQUFWLENBQWVDLFVBekROOztBQTJEakI7OztBQUdBbkMsV0FBUyxvQkFBVWtDLElBQVYsQ0FBZUMsVUE5RFA7O0FBZ0VqQjs7O0FBR0FqQyxrQkFBZ0Isb0JBQVVnQyxJQUFWLENBQWVDLFVBbkVkOztBQXFFakI7OztBQUdBL0IsbUJBQWlCLG9CQUFVOEIsSUFBVixDQUFlQyxVQXhFZjs7QUEwRWpCOzs7QUFHQWpFLG9CQUFrQixvQkFBVTZEO0FBN0VYLEM7QUFEQS9ELE8sQ0FpRlp3RSxZLEdBQWU7QUFDcEJ0QixZQUFVLHFCQUFTdUIsTUFEQztBQUVwQmxFLFdBQVMsS0FGVztBQUdwQjBDLFlBQVUsR0FIVTtBQUlwQkUsYUFBVyxFQUpTO0FBS3BCRSxxQkFBbUIsR0FMQztBQU1wQlAsVUFBUSxFQU5ZO0FBT3BCaEIsVUFBUSxrQkFBTSxDQUFFLENBUEk7QUFRcEJFLFdBQVMsbUJBQU0sQ0FBRSxDQVJHO0FBU3BCRSxrQkFBZ0IsMEJBQU0sQ0FBRSxDQVRKO0FBVXBCRSxtQkFBaUIsMkJBQU0sQ0FBRSxDQVZMO0FBV3BCbEMsb0JBQWtCO0FBWEUsQztrQkFqRkhGLE8iLCJmaWxlIjoiUG9wb3Zlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBDb21wb25lbnQgfSBmcm9tICdyZWFjdCdcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcydcbmltcG9ydCB7IFBvc2l0aW9uLCBQb3NpdGlvbmVyIH0gZnJvbSAnLi4vLi4vcG9zaXRpb25lcidcbmltcG9ydCBQb3BvdmVyU3RhdGVsZXNzIGZyb20gJy4vUG9wb3ZlclN0YXRlbGVzcydcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUG9wb3ZlciBleHRlbmRzIENvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgLyoqXG4gICAgICogVGhlIHBvc2l0aW9uIHRoZSBQb3BvdmVyIGlzIG9uLiBTbWFydCBwb3NpdGlvbmluZyBtaWdodCBvdmVycmlkZSB0aGlzLlxuICAgICAqL1xuICAgIHBvc2l0aW9uOiBQcm9wVHlwZXMub25lT2YoT2JqZWN0LmtleXMoUG9zaXRpb24pKSxcblxuICAgIC8qKlxuICAgICAqIFdoZW4gdHJ1ZSwgdGhlIFBvcG92ZXIgaXMgbWFudWFsbHkgc2hvd24uXG4gICAgICovXG4gICAgaXNTaG93bjogUHJvcFR5cGVzLmJvb2wsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgY29udGVudCBvZiB0aGUgUG9wb3Zlci5cbiAgICAgKi9cbiAgICBjb250ZW50OiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMubm9kZSwgUHJvcFR5cGVzLmZ1bmNdKS5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHRhcmdldCBidXR0b24gb2YgdGhlIFBvcG92ZXIuXG4gICAgICogV2hlbiBhIGZ1bmN0aW9uIHRoZSBmb2xsb3dpbmcgYXJndW1lbnRzIGFyZSBwYXNzZWQ6XG4gICAgICogKHsgdG9nZ2xlOiBGdW5jdGlvbiAtPiBWb2lkLCBnZXRSZWY6IEZ1bmN0aW9uIC0+IFJlZiwgaXNTaG93bjogQm9vbCB9KVxuICAgICAqL1xuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuZWxlbWVudCwgUHJvcFR5cGVzLmZ1bmNdKVxuICAgICAgLmlzUmVxdWlyZWQsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgZGlzcGxheSBwcm9wZXJ0eSBwYXNzZWQgdG8gdGhlIFBvcG92ZXIgY2FyZC5cbiAgICAgKi9cbiAgICBkaXNwbGF5OiBQcm9wVHlwZXMuc3RyaW5nLFxuXG4gICAgLyoqXG4gICAgICogVGhlIG1pbiB3aWR0aCBvZiB0aGUgUG9wb3ZlciBjYXJkLlxuICAgICAqL1xuICAgIG1pbldpZHRoOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMubnVtYmVyLCBQcm9wVHlwZXMuc3RyaW5nXSksXG5cbiAgICAvKipcbiAgICAgKiBUaGUgbWluIGhlaWdodCBvZiB0aGUgUG9wb3ZlciBjYXJkLlxuICAgICAqL1xuICAgIG1pbkhlaWdodDogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLm51bWJlciwgUHJvcFR5cGVzLnN0cmluZ10pLFxuXG4gICAgLyoqXG4gICAgICogUHJvcGVydGllcyBwYXNzZWQgdGhyb3VnaCB0byB0aGUgUG9wb3ZlciBjYXJkLlxuICAgICAqL1xuICAgIHN0YXRlbGVzc1Byb3BzOiBQcm9wVHlwZXMub2JqZWN0T2YoUG9wb3ZlclN0YXRlbGVzcy5wcm9wVHlwZXMpLFxuXG4gICAgLyoqXG4gICAgICogRHVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbi5cbiAgICAgKi9cbiAgICBhbmltYXRpb25EdXJhdGlvbjogUHJvcFR5cGVzLm51bWJlcixcblxuICAgIC8qKlxuICAgICAqIFRoZSB6LWluZGV4IG9mIHRoZSBQb3BvdmVyIGNhcmQuXG4gICAgICovXG4gICAgekluZGV4OiBQcm9wVHlwZXMubnVtYmVyLFxuXG4gICAgLyoqXG4gICAgICogRnVuY3Rpb24gY2FsbGVkIHdoZW4gdGhlIFBvcG92ZXIgb3BlbnMuXG4gICAgICovXG4gICAgb25PcGVuOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogRnVuY3Rpb24gZmlyZWQgd2hlbiBQb3BvdmVyIGNsb3Nlcy5cbiAgICAgKi9cbiAgICBvbkNsb3NlOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBlbnRlciB0cmFuc2l0aW9uIGlzIGNvbXBsZXRlLlxuICAgICAqL1xuICAgIG9uT3BlbkNvbXBsZXRlOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBleGl0IHRyYW5zaXRpb24gaXMgY29tcGxldGUuXG4gICAgICovXG4gICAgb25DbG9zZUNvbXBsZXRlOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogV2hlbiB0cnVlLCBicmluZyBmb2N1cyBpbnNpZGUgb2YgdGhlIFBvcG92ZXIgb24gb3Blbi5cbiAgICAgKi9cbiAgICBicmluZ0ZvY3VzSW5zaWRlOiBQcm9wVHlwZXMuYm9vbFxuICB9XG5cbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBwb3NpdGlvbjogUG9zaXRpb24uQk9UVE9NLFxuICAgIGlzU2hvd246IGZhbHNlLFxuICAgIG1pbldpZHRoOiAyMDAsXG4gICAgbWluSGVpZ2h0OiA0MCxcbiAgICBhbmltYXRpb25EdXJhdGlvbjogMzAwLFxuICAgIHpJbmRleDogNDAsXG4gICAgb25PcGVuOiAoKSA9PiB7fSxcbiAgICBvbkNsb3NlOiAoKSA9PiB7fSxcbiAgICBvbk9wZW5Db21wbGV0ZTogKCkgPT4ge30sXG4gICAgb25DbG9zZUNvbXBsZXRlOiAoKSA9PiB7fSxcbiAgICBicmluZ0ZvY3VzSW5zaWRlOiB0cnVlXG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgIHN1cGVyKHByb3BzKVxuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICBpc1Nob3duOiBwcm9wcy5pc1Nob3duXG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25Cb2R5Q2xpY2ssIGZhbHNlKVxuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMub25Fc2MsIGZhbHNlKVxuICB9XG5cbiAgLyoqXG4gICAqIE1ldGhvZHMgYm9ycm93ZWQgZnJvbSBCbHVlcHJpbnRKU1xuICAgKiBodHRwczovL2dpdGh1Yi5jb20vcGFsYW50aXIvYmx1ZXByaW50L2Jsb2IvcmVsZWFzZS8yLjAuMC9wYWNrYWdlcy9jb3JlL3NyYy9jb21wb25lbnRzL292ZXJsYXkvb3ZlcmxheS50c3hcbiAgICovXG4gIGJyaW5nRm9jdXNJbnNpZGUgPSAoKSA9PiB7XG4gICAgaWYgKCF0aGlzLnByb3BzLmJyaW5nRm9jdXNJbnNpZGUpIHJldHVyblxuXG4gICAgLy8gQWx3YXlzIGRlbGF5IGZvY3VzIG1hbmlwdWxhdGlvbiB0byBqdXN0IGJlZm9yZSByZXBhaW50IHRvIHByZXZlbnQgc2Nyb2xsIGp1bXBpbmdcbiAgICByZXR1cm4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIC8vIENvbnRhaW5lciByZWYgbWF5IGJlIHVuZGVmaW5lZCBiZXR3ZWVuIGNvbXBvbmVudCBtb3VudGluZyBhbmQgUG9ydGFsIHJlbmRlcmluZ1xuICAgICAgLy8gYWN0aXZlRWxlbWVudCBtYXkgYmUgdW5kZWZpbmVkIGluIHNvbWUgcmFyZSBjYXNlcyBpbiBJRVxuXG4gICAgICBpZiAoXG4gICAgICAgIHRoaXMucG9wb3Zlck5vZGUgPT0gbnVsbCB8fCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGVxZXFlcSwgbm8tZXEtbnVsbFxuICAgICAgICBkb2N1bWVudC5hY3RpdmVFbGVtZW50ID09IG51bGwgfHwgLy8gZXNsaW50LWRpc2FibGUtbGluZSBlcWVxZXEsIG5vLWVxLW51bGxcbiAgICAgICAgIXRoaXMucHJvcHMuaXNTaG93blxuICAgICAgKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBjb25zdCBpc0ZvY3VzT3V0c2lkZU1vZGFsID0gIXRoaXMucG9wb3Zlck5vZGUuY29udGFpbnMoXG4gICAgICAgIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnRcbiAgICAgIClcbiAgICAgIGlmIChpc0ZvY3VzT3V0c2lkZU1vZGFsKSB7XG4gICAgICAgIC8vIEVsZW1lbnQgbWFya2VkIGF1dG9mb2N1cyBoYXMgaGlnaGVyIHByaW9yaXR5IHRoYW4gdGhlIG90aGVyIGNsb3duc1xuICAgICAgICBjb25zdCBhdXRvZm9jdXNFbGVtZW50ID0gdGhpcy5wb3BvdmVyTm9kZS5xdWVyeVNlbGVjdG9yKCdbYXV0b2ZvY3VzXScpXG4gICAgICAgIGNvbnN0IHdyYXBwZXJFbGVtZW50ID0gdGhpcy5wb3BvdmVyTm9kZS5xdWVyeVNlbGVjdG9yKCdbdGFiaW5kZXhdJylcbiAgICAgICAgY29uc3QgYnV0dG9uRWxlbWVudCA9IHRoaXMucG9wb3Zlck5vZGUucXVlcnlTZWxlY3RvcignYnV0dG9uJylcblxuICAgICAgICBpZiAoYXV0b2ZvY3VzRWxlbWVudCkge1xuICAgICAgICAgIGF1dG9mb2N1c0VsZW1lbnQuZm9jdXMoKVxuICAgICAgICB9IGVsc2UgaWYgKHdyYXBwZXJFbGVtZW50KSB7XG4gICAgICAgICAgd3JhcHBlckVsZW1lbnQuZm9jdXMoKVxuICAgICAgICB9IGVsc2UgaWYgKGJ1dHRvbkVsZW1lbnQpIHtcbiAgICAgICAgICBidXR0b25FbGVtZW50LmZvY3VzKClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBicmluZ0ZvY3VzQmFja1RvVGFyZ2V0ID0gKCkgPT4ge1xuICAgIHJldHVybiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICB0aGlzLnBvcG92ZXJOb2RlID09IG51bGwgfHwgLy8gZXNsaW50LWRpc2FibGUtbGluZSBlcWVxZXEsIG5vLWVxLW51bGxcbiAgICAgICAgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PSBudWxsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgZXFlcWVxLCBuby1lcS1udWxsXG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGlzRm9jdXNJbnNpZGVNb2RhbCA9IHRoaXMucG9wb3Zlck5vZGUuY29udGFpbnMoXG4gICAgICAgIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnRcbiAgICAgIClcblxuICAgICAgLy8gQnJpbmcgYmFjayBmb2N1cyBvbiB0aGUgdGFyZ2V0LlxuICAgICAgaWYgKFxuICAgICAgICB0aGlzLnRhcmdldFJlZiAmJlxuICAgICAgICAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PT0gZG9jdW1lbnQuYm9keSB8fCBpc0ZvY3VzSW5zaWRlTW9kYWwpXG4gICAgICApIHtcbiAgICAgICAgdGhpcy50YXJnZXRSZWYuZm9jdXMoKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBvbkJvZHlDbGljayA9IGUgPT4ge1xuICAgIC8vIElnbm9yZSBjbGlja3Mgb24gdGhlIHBvcG92ZXIgb3IgYnV0dG9uXG4gICAgaWYgKHRoaXMudGFyZ2V0UmVmID09PSBlLnRhcmdldCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgdGhpcy5wb3BvdmVyTm9kZSAmJlxuICAgICAgKHRoaXMucG9wb3Zlck5vZGUgPT09IGUudGFyZ2V0IHx8IHRoaXMucG9wb3Zlck5vZGUuY29udGFpbnMoZS50YXJnZXQpKVxuICAgICkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgdGhpcy5jbG9zZSgpXG4gIH1cblxuICBvbkVzYyA9IGUgPT4ge1xuICAgIC8vIEVzYyBrZXlcbiAgICBpZiAoZS5rZXlDb2RlID09PSAyNykge1xuICAgICAgdGhpcy5jbG9zZSgpXG4gICAgfVxuICB9XG5cbiAgdG9nZ2xlID0gKCkgPT4ge1xuICAgIGlmICh0aGlzLnN0YXRlLmlzU2hvd24pIHtcbiAgICAgIHRoaXMuY2xvc2UoKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm9wZW4oKVxuICAgIH1cbiAgfVxuXG4gIG9wZW4gPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMuc3RhdGUuaXNTaG93bikge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgdGhpcy5zZXRTdGF0ZSh7IGlzU2hvd246IHRydWUgfSlcbiAgICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5vbkJvZHlDbGljaywgZmFsc2UpXG4gICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5vbkVzYywgZmFsc2UpXG5cbiAgICB0aGlzLnByb3BzLm9uT3BlbigpXG4gIH1cblxuICBjbG9zZSA9ICgpID0+IHtcbiAgICBpZiAoIXRoaXMuc3RhdGUuaXNTaG93bikge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgdGhpcy5zZXRTdGF0ZSh7IGlzU2hvd246IGZhbHNlIH0pXG4gICAgZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25Cb2R5Q2xpY2ssIGZhbHNlKVxuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMub25Fc2MsIGZhbHNlKVxuXG4gICAgdGhpcy5icmluZ0ZvY3VzQmFja1RvVGFyZ2V0KClcblxuICAgIHRoaXMucHJvcHMub25DbG9zZSgpXG4gIH1cblxuICBoYW5kbGVPcGVuQ29tcGxldGUgPSAoKSA9PiB7XG4gICAgdGhpcy5icmluZ0ZvY3VzSW5zaWRlKClcbiAgICB0aGlzLnByb3BzLm9uT3BlbkNvbXBsZXRlKClcbiAgfVxuXG4gIGhhbmRsZUNsb3NlQ29tcGxldGUgPSAoKSA9PiB7XG4gICAgdGhpcy5wcm9wcy5vbkNsb3NlQ29tcGxldGUoKVxuICB9XG5cbiAgcmVuZGVyVGFyZ2V0ID0gKHsgZ2V0UmVmLCBpc1Nob3duIH0pID0+IHtcbiAgICBjb25zdCB7IGNoaWxkcmVuIH0gPSB0aGlzLnByb3BzXG5cbiAgICBjb25zdCBnZXRUYXJnZXRSZWYgPSByZWYgPT4ge1xuICAgICAgdGhpcy50YXJnZXRSZWYgPSByZWZcbiAgICAgIGdldFJlZihyZWYpXG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBjaGlsZHJlbiA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgcmV0dXJuIGNoaWxkcmVuKHtcbiAgICAgICAgdG9nZ2xlOiB0aGlzLnRvZ2dsZSxcbiAgICAgICAgZ2V0UmVmOiBnZXRUYXJnZXRSZWYsXG4gICAgICAgIGlzU2hvd25cbiAgICAgIH0pXG4gICAgfVxuXG4gICAgcmV0dXJuIFJlYWN0LmNsb25lRWxlbWVudChjaGlsZHJlbiwge1xuICAgICAgb25DbGljazogdGhpcy50b2dnbGUsXG4gICAgICBpbm5lclJlZjogZ2V0VGFyZ2V0UmVmLFxuICAgICAgcm9sZTogJ2J1dHRvbicsXG4gICAgICAnYXJpYS1leHBhbmRlZCc6IGlzU2hvd24sXG4gICAgICAnYXJpYS1oYXNwb3B1cCc6IHRydWVcbiAgICB9KVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHpJbmRleCxcbiAgICAgIGlzU2hvd24sXG4gICAgICBjb250ZW50LFxuICAgICAgZGlzcGxheSxcbiAgICAgIG1pbldpZHRoLFxuICAgICAgcG9zaXRpb24sXG4gICAgICBtaW5IZWlnaHQsXG4gICAgICBzdGF0ZWxlc3NQcm9wcyxcbiAgICAgIGFuaW1hdGlvbkR1cmF0aW9uLFxuICAgICAgb25DbG9zZUNvbXBsZXRlXG4gICAgfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCB7IGlzU2hvd246IHN0YXRlSXNTaG93biB9ID0gdGhpcy5zdGF0ZVxuXG4gICAgY29uc3Qgc2hvd24gPSBpc1Nob3duIHx8IHN0YXRlSXNTaG93blxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxQb3NpdGlvbmVyXG4gICAgICAgIHRhcmdldD17KHsgZ2V0UmVmLCBpc1Nob3duLCB0YXJnZXRXaWR0aCB9KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVyVGFyZ2V0KHsgZ2V0UmVmLCBpc1Nob3duLCB0YXJnZXRXaWR0aCB9KVxuICAgICAgICB9fVxuICAgICAgICB6SW5kZXg9e3pJbmRleH1cbiAgICAgICAgaXNTaG93bj17c2hvd259XG4gICAgICAgIHBvc2l0aW9uPXtwb3NpdGlvbn1cbiAgICAgICAgYW5pbWF0aW9uRHVyYXRpb249e2FuaW1hdGlvbkR1cmF0aW9ufVxuICAgICAgICBvbk9wZW5Db21wbGV0ZT17dGhpcy5oYW5kbGVPcGVuQ29tcGxldGV9XG4gICAgICAgIG9uQ2xvc2VDb21wbGV0ZT17b25DbG9zZUNvbXBsZXRlfVxuICAgICAgPlxuICAgICAgICB7KHsgY3NzLCBzdHlsZSwgc3RhdGUsIGdldFJlZiB9KSA9PiAoXG4gICAgICAgICAgPFBvcG92ZXJTdGF0ZWxlc3NcbiAgICAgICAgICAgIGlubmVyUmVmPXtyZWYgPT4ge1xuICAgICAgICAgICAgICB0aGlzLnBvcG92ZXJOb2RlID0gcmVmXG4gICAgICAgICAgICAgIGdldFJlZihyZWYpXG4gICAgICAgICAgICB9fVxuICAgICAgICAgICAgZGF0YS1zdGF0ZT17c3RhdGV9XG4gICAgICAgICAgICBjc3M9e2Nzc31cbiAgICAgICAgICAgIHN0eWxlPXtzdHlsZX1cbiAgICAgICAgICAgIGRpc3BsYXk9e2Rpc3BsYXl9XG4gICAgICAgICAgICBtaW5XaWR0aD17bWluV2lkdGh9XG4gICAgICAgICAgICBtaW5IZWlnaHQ9e21pbkhlaWdodH1cbiAgICAgICAgICAgIHsuLi5zdGF0ZWxlc3NQcm9wc31cbiAgICAgICAgICA+XG4gICAgICAgICAgICB7dHlwZW9mIGNvbnRlbnQgPT09ICdmdW5jdGlvbidcbiAgICAgICAgICAgICAgPyBjb250ZW50KHsgY2xvc2U6IHRoaXMuY2xvc2UgfSlcbiAgICAgICAgICAgICAgOiBjb250ZW50fVxuICAgICAgICAgIDwvUG9wb3ZlclN0YXRlbGVzcz5cbiAgICAgICAgKX1cbiAgICAgIDwvUG9zaXRpb25lcj5cbiAgICApXG4gIH1cbn1cbiJdfQ==